<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valeo Bakƒ±m Portalƒ± - V2 PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --valeo-green: #99cc00; 
            --valeo-blue: #0091ff; 
            --valeo-dark: #1a1a1b; 
            --bg-gray: #f8f9fa; 
            --card-bg: #ffffff; 
            --text-main: #2d3436; 
            --text-sub: #636e72; 
            --danger: #ff4757; 
            --warning: #f1c40f;
            --shadow: 0 10px 25px rgba(0,0,0,0.08); 
            --border: #edf2f7;
        }
        
        body.dark-mode { 
            --bg-gray: #121212; 
            --card-bg: #1e1e1e; 
            --text-main: #f5f6fa; 
            --text-sub: #b2bec3; 
            --valeo-dark: #000000; 
            --border: #2d3436;
            --shadow: 0 10px 25px rgba(0,0,0,0.4);
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-gray); color: var(--text-main); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; transition: 0.3s; padding: 10px; box-sizing: border-box; }
        
        .container { 
            background: var(--card-bg); 
            width: 100%; 
            max-width: 500px; 
            height: 95vh; 
            max-height: 900px; 
            border-radius: 24px; 
            box-shadow: var(--shadow); 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            position: relative; 
            border: 1px solid var(--border); 
        }

        #offline-status {
            text-align: center;
            padding: 8px;
            font-size: 11px;
            font-weight: 800;
            display: none;
            z-index: 100;
        }

        @media (min-width: 768px) { .container { max-width: 600px; height: 85vh; } }

        .modal-overlay {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-card {
            background: var(--card-bg);
            width: 85%;
            max-width: 350px;
            border-radius: 24px;
            padding: 30px;
            text-align: center;
            box-shadow: var(--shadow);
            animation: modalSlideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes modalSlideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-icon { font-size: 45px; margin-bottom: 15px; }
        .modal-title { font-weight: 800; font-size: 20px; margin-bottom: 10px; color: var(--text-main); }
        .modal-text { font-size: 14px; color: var(--text-sub); margin-bottom: 25px; line-height: 1.5; }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 15px; border-radius: 14px; font-weight: 700; cursor: pointer; border: none; transition: 0.2s; font-size: 13px; }
        .btn-confirm { background: var(--valeo-green); color: white; }
        .btn-cancel { background: var(--bg-gray); color: var(--text-main); }

        #loading-overlay {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85);
            z-index: 1000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }
        body.dark-mode #loading-overlay { background: rgba(0, 0, 0, 0.85); }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid var(--border);
            border-top: 4px solid var(--valeo-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .top-bar { background: var(--valeo-dark); color: white; padding: 18px; display: flex; justify-content: space-between; align-items: center; z-index: 10; flex-shrink: 0; }
        .content { padding: 20px; overflow-y: auto; flex-grow: 1; position: relative; }
        
        input { width: 100%; padding: 16px; margin: 10px 0; border-radius: 12px; border: 2px solid var(--border); background: var(--card-bg); color: var(--text-main); font-size: 15px; box-sizing: border-box; transition: 0.2s; }
        input:focus { border-color: var(--valeo-green); outline: none; }
        
        button { background: var(--valeo-green); color: white; border: none; padding: 18px; border-radius: 14px; font-weight: 700; cursor: pointer; width: 100%; transition: 0.2s; }
        button:disabled { background: #cbd5e0 !important; opacity: 0.6; cursor: not-allowed; }
        
        .product-card { background: var(--card-bg); border: 1px solid var(--border); margin-bottom: 12px; padding: 15px; border-radius: 15px; border-left: 5px solid var(--valeo-green); cursor: pointer; transition: 0.2s; }
        .product-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        
        .page { display: none; height: 100%; flex-direction: column; animation: fadeIn 0.3s; }
        .active-page { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        #detail-image-panel { width: 100%; height: 200px; border-radius: 15px; overflow: hidden; margin-bottom: 15px; border: 1px solid var(--border); display: none; }
        #detail-frame { width: 100%; height: 100%; border: none; }
        
        .stepper { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 20px 0; background: var(--bg-gray); padding: 10px; border-radius: 15px; }
        .stepper button { width: 50px; height: 50px; border-radius: 50%; background: var(--valeo-dark); font-size: 20px; padding: 0; color: white; }
        #islem-adet { width: 70px; text-align: center; font-size: 24px; font-weight: 800; border: none; background: transparent; color: var(--text-main); }
        
        .dropdown-menu { display: none; position: absolute; right: 15px; top: 60px; background: var(--card-bg); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 50; min-width: 170px; overflow: hidden; border: 1px solid var(--border); }
        .dropdown-menu div { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 14px; color: var(--text-main); }
        
        .history-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; }
        .history-table th { background: var(--valeo-dark); color: white; padding: 10px 5px; text-align: left; position: sticky; top: 0; }
        .history-table td { padding: 10px 5px; border-bottom: 1px solid var(--border); color: var(--text-main); }

        mark { background: #99cc00; color: #000; padding: 0 1px; border-radius: 2px; font-weight: bold; }
    </style>
</head>
<body onclick="closeMenuOutside(event)">

<div class="container">
    <div id="offline-status"></div>

    <div id="custom-modal" class="modal-overlay">
        <div class="modal-card">
            <div id="modal-icon" class="modal-icon">‚ö†Ô∏è</div>
            <div id="modal-title" class="modal-title">Emin misiniz?</div>
            <div id="modal-text" class="modal-text">Bu i≈ülemi onaylƒ±yor musunuz?</div>
            <div class="modal-buttons">
                <button id="modal-cancel-btn" class="modal-btn btn-cancel" onclick="closeModal()">ƒ∞PTAL</button>
                <button id="modal-confirm-btn" class="modal-btn btn-confirm">ONAYLA</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text" style="font-weight: 800; color: var(--valeo-green);">ƒ∞≈ûLEMƒ∞Nƒ∞Z DEVAM EDƒ∞YOR...</div>
        <div style="font-size: 12px; margin-top: 5px; opacity: 0.7;">L√ºtfen bekleyiniz.</div>
    </div>

    <div id="main-top-bar" class="top-bar" style="display:none;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div id="btn-back" onclick="goBack()" style="display:none; cursor:pointer; font-size:18px;">‚¨ÖÔ∏è</div>
            <div style="font-size: 12px; font-weight: 800; letter-spacing: 1px;">VALEO PORTAL</div>
        </div>
        <div style="cursor:pointer; font-size: 20px;" onclick="toggleMenu(event)">‚ò∞</div>
        <div id="dropdown" class="dropdown-menu">
            <div onclick="toggleDarkMode()">üåì Karanlƒ±k Mod</div>
            <div onclick="gecmisGoster()">üìã ƒ∞≈ülem Ge√ßmi≈üi</div>
            <div onclick="guvenliCikis()" style="color:var(--danger)">üö™ √áƒ±kƒ±≈ü Yap</div>
        </div>
    </div>

    <div id="page-login" class="page active-page">
        <div onclick="toggleDarkMode()" style="position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; z-index: 100;">üåì</div>
        <div class="content" style="text-align:center; justify-content: center; display: flex; flex-direction: column;">
            <h1 style="color:var(--valeo-green); font-size:48px; margin:0; font-weight:800;">Valeo</h1>
            <p style="letter-spacing:3px; font-size:10px; opacity:0.6; margin-bottom:40px; font-weight:600;">BAKIM DEPO Sƒ∞STEMƒ∞</p>
            <input type="text" id="user-input" placeholder="Kullanƒ±cƒ± Adƒ±">
            <input type="password" id="pass-input" placeholder="≈ûifre">
            <button onclick="girisYap()">Sƒ∞STEME Gƒ∞Rƒ∞≈û</button>
        </div>
    </div>

    <div id="page-search" class="page">
        <div class="content">
            <h3 style="margin-top:0; font-weight: 800; letter-spacing: -0.5px;">Stok Arama</h3>
            <div style="position:relative; margin-bottom: 20px;">
                <input type="text" id="search-main" placeholder="Malzeme adƒ± veya SAP no..." oninput="aramaYap()" style="padding-left:45px; height: 60px; border-radius: 16px;">
                <span style="position:absolute; left:15px; top:20px; font-size: 20px; opacity:0.5;">üîç</span>
            </div>
            <div id="search-results" style="display: flex; flex-direction: column; gap: 10px;"></div>
        </div>
    </div>

    <div id="page-detail" class="page">
        <div class="content">
            <div id="detail-image-panel"><iframe id="detail-frame" src=""></iframe></div>
            <button id="btn-toggle-img" onclick="toggleImage()" style="background:var(--valeo-dark); margin-bottom:15px; padding:10px; font-size:12px; height: auto; width: auto; display: inline-block;">
                üñºÔ∏è G√ñRSELƒ∞ G√ñSTER
            </button>
            <h2 id="detay-ad" style="margin:5px 0; font-size:22px;"></h2>
            <div id="detay-sap" style="font-weight:900; color:var(--valeo-green); font-size:18px; margin-bottom:15px;"></div>
            <div style="background:var(--bg-gray); padding:15px; border-radius:12px; font-size:14px; border: 1px solid var(--border);">
                <div style="margin-bottom:8px;">üìç <b>Adres:</b> <span id="detay-adres"></span></div>
                <div>üì¶ <b>Stok:</b> <span id="detay-stok"></span> ADET</div>
            </div>
            <button onclick="goToAction()" style="margin-top:25px; background:var(--valeo-blue);">BU √úR√úN√ú SE√á</button>
        </div>
    </div>

    <div id="page-action" class="page">
        <div class="content">
            <label style="font-weight:bold; font-size:12px; color:var(--text-sub); letter-spacing: 1px;">MAKƒ∞NE SE√áƒ∞Mƒ∞</label>
            <div style="position:relative;">
                <input type="text" id="action-machine-search" placeholder="Makine kodu veya adƒ± ile ara..." oninput="makineAramaYap()" style="padding-left:45px;">
                <span style="position:absolute; left:15px; top:25px; opacity:0.5;">üîç</span>
            </div>

            <div id="selected-machine-box" style="display:none; background: linear-gradient(135deg, var(--valeo-blue), #00d2ff); color: white; padding: 15px; border-radius: 16px; margin: 10px 0; box-shadow: 0 4px 15px rgba(0,145,255,0.3);">
                <div style="font-size:11px; opacity:0.9; margin-bottom:4px; font-weight:600;">SE√áƒ∞Lƒ∞ MAKƒ∞NE</div>
                <div id="selected-machine-text" style="font-weight:800; font-size:16px;"></div>
            </div>

            <div id="machine-results" style="max-height:220px; overflow-y:auto; margin-top:5px; border-radius:12px;"></div>
            
            <div style="margin-top:25px; text-align:center; background:var(--bg-gray); padding:20px; border-radius:20px; border:1px solid var(--border);">
                <label style="font-weight:bold; font-size:12px; color:var(--text-sub);">ƒ∞≈ûLEM ADEDƒ∞</label>
                <div class="stepper">
                    <button onclick="adetDegistir(-1)" style="box-shadow: 0 4px 10px rgba(0,0,0,0.1);">-</button>
                    <input type="number" id="islem-adet" value="0" readonly>
                    <button onclick="adetDegistir(1)" style="box-shadow: 0 4px 10px rgba(0,0,0,0.1);">+</button>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="btn-dusum" style="background:var(--danger); flex: 1; padding: 20px 10px;" onclick="finalOnay('STOKTAN D√ú≈û√úM')" disabled>üìâ D√ú≈û√úM</button>
                <button id="btn-talep" style="background:var(--valeo-dark); flex: 1; padding: 20px 10px;" onclick="finalOnay('Sƒ∞PARƒ∞≈û TALEBƒ∞')" disabled>üõí TALEP</button>
            </div>
        </div>
    </div>

    <div id="page-history" class="page">
        <div class="content">
            <h3 style="margin-top:0;">Son ƒ∞≈ülemler</h3>
            <div style="overflow-x: auto;">
                <table class="history-table">
                    <thead>
                        <tr><th>SAP</th><th>ADET</th><th>Tƒ∞P</th><th>PERS</th><th>TARƒ∞H</th></tr>
                    </thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxGCCJo34saMWKeLiFKUaWZzZh3k4sIoAiRYZ_oV7rNPWtf60UaXJUKWIn0g27RRMsIRg/exec';
    const URUN_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBzW/pub?gid=1489941403&single=true&output=csv';
    const USER_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBzW/pub?gid=1584268931&single=true&output=csv';
    const MAKINA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBzW/pub?gid=1658888580&single=true&output=csv';
    const GECMIS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBzW/pub?gid=185766952&single=true&output=csv';

    let urunler = [], makineler = [], kullanicilar = [], seciliUrun = null, seciliMakina = null;
    let isSyncing = false;

    // --- √áEVRƒ∞MDI≈ûI √ñZELLƒ∞KLERƒ∞ (UNTITLED1'DEN AKTARILAN) ---
    function getQueue() { return JSON.parse(localStorage.getItem('valeo_offline_queue') || '[]'); }
    function setQueue(q) { 
        localStorage.setItem('valeo_offline_queue', JSON.stringify(q));
        updateOnlineStatus();
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);

    function updateOnlineStatus() {
        const bar = document.getElementById('offline-status');
        const queue = getQueue();
        if (navigator.onLine) {
            bar.style.display = 'block'; bar.style.background = 'var(--valeo-green)'; bar.style.color = '#fff';
            bar.innerHTML = '‚úÖ Sƒ∞STEM √áEVRƒ∞Mƒ∞√áƒ∞'; 
            processQueue(); 
        } else {
            bar.style.display = 'block'; bar.style.background = 'var(--warning)'; bar.style.color = '#000';
            bar.innerHTML = `‚ö†Ô∏è √áEVRƒ∞MDI≈ûI MOD: ${queue.length} BEKLEYEN ƒ∞≈ûLEM`;
        }
    }

    async function processQueue() {
        if (isSyncing || !navigator.onLine) return;
        let queue = getQueue();
        if (queue.length === 0) return;
        isSyncing = true;
        
        while (queue.length > 0) {
            const item = queue[0];
            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(item) });
                queue.shift();
                localStorage.setItem('valeo_offline_queue', JSON.stringify(queue));
            } catch (e) { break; }
        }
        isSyncing = false;
        updateOnlineStatus();
    }
    // -------------------------------------------------------

    function closeModal() { document.getElementById('custom-modal').style.display = 'none'; }

    function finalOnay(islem) {
        const modal = document.getElementById('custom-modal');
        const confirmBtn = document.getElementById('modal-confirm-btn');
        const adet = document.getElementById('islem-adet').value;
        document.getElementById('modal-cancel-btn').style.display = 'block';
        confirmBtn.innerText = 'ONAYLA';
        document.getElementById('modal-icon').innerText = islem === 'STOKTAN D√ú≈û√úM' ? 'üìâ' : 'üõí';
        document.getElementById('modal-title').innerText = islem;
        document.getElementById('modal-text').innerHTML = `<b>${seciliUrun[1]}</b> √ºr√ºn√ºnden <b>${adet} adet</b> i√ßin i≈ülem yapƒ±lacaktƒ±r.<br><br>Onaylƒ±yor musunuz?`;
        confirmBtn.style.background = islem === 'STOKTAN D√ú≈û√úM' ? 'var(--danger)' : 'var(--valeo-blue)';
        confirmBtn.onclick = function() { closeModal(); kaydet(islem, adet); };
        modal.style.display = 'flex';
    }

    function showSuccessModal(isOffline = false) {
        const modal = document.getElementById('custom-modal');
        const confirmBtn = document.getElementById('modal-confirm-btn');
        document.getElementById('modal-cancel-btn').style.display = 'none';
        document.getElementById('modal-icon').innerText = isOffline ? '‚è≥' : '‚úÖ';
        document.getElementById('modal-title').innerText = isOffline ? 'KUYRUƒûA ALINDI' : 'BA≈ûARILI';
        document.getElementById('modal-text').innerText = isOffline ? 'Baƒülantƒ± gelince otomatik g√∂nderilecek.' : 'ƒ∞≈üleminiz kaydedildi.';
        confirmBtn.innerText = 'TAMAM';
        confirmBtn.style.background = 'var(--valeo-green)';
        confirmBtn.onclick = function() { closeModal(); showPage('page-search'); };
        modal.style.display = 'flex';
    }

    function trNormalize(text) {
        if (!text) return "";
        return text.toString().replace(/ƒ∞/g, 'i').replace(/I/g, 'i').toLowerCase()
            .replace(/ƒü/g, 'g').replace(/√º/g, 'u').replace(/≈ü/g, 's')
            .replace(/ƒ±/g, 'i').replace(/√∂/g, 'o').replace(/√ß/g, 'c').trim();
    }

    function safeHighlight(text, terms) {
        if (!text || !terms || terms.length === 0) return text;
        let highlighted = String(text);
        terms.forEach(term => {
            const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            highlighted = highlighted.replace(regex, '<mark>$1</mark>');
        });
        return highlighted;
    }

    function aramaYap() {
        const rawInput = document.getElementById('search-main').value;
        const resultsContainer = document.getElementById('search-results');
        
        if (!rawInput || !rawInput.trim()) { 
            resultsContainer.innerHTML = `<div style="text-align:center; margin-top:40px; opacity:0.4;">üì¶ Aramaya ba≈ülayƒ±n...</div>`; 
            return; 
        }

        const queryNormalized = trNormalize(rawInput);
        const searchTerms = queryNormalized.split(/\s+/).filter(t => t.length > 0);
        
        const filtered = urunler.filter(u => {
            const targetText = trNormalize((u[0] || "") + " " + (u[1] || ""));
            return searchTerms.every(term => targetText.includes(term));
        });

        resultsContainer.innerHTML = filtered.slice(0, 25).map(u => {
            const displaySap = safeHighlight(String(u[0]), searchTerms);
            const displayAd = safeHighlight(String(u[1]), searchTerms);
            const stokAdet = parseInt(u[3] || 0);
            const stokRenk = stokAdet <= 0 ? 'var(--danger)' : 'var(--valeo-green)';

            return `
                <div class="product-card" onclick="openDetail('${u[0]}')" style="border-left: 6px solid ${stokRenk}; padding: 18px;">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div style="font-weight:900; color:var(--valeo-blue); font-size:13px;">SAP: ${displaySap}</div>
                        <div style="background:${stokRenk}20; color:${stokRenk}; padding:4px 8px; border-radius:8px; font-size:11px; font-weight:800;">${stokAdet} ADET</div>
                    </div>
                    <div style="font-weight:700; font-size:15px; color:var(--text-main); margin-top:8px;">${displayAd}</div>
                    <div style="font-size:12px; color:var(--text-sub); margin-top:10px;">üìç Adres: ${u[2] || "-"}</div>
                </div>`;
        }).join('');
    }

    function openDetail(sap) {
        seciliUrun = urunler.find(u => u[0].toString() === sap.toString());
        if(!seciliUrun) return;
        document.getElementById('detay-ad').innerText = seciliUrun[1];
        document.getElementById('detay-sap').innerText = "SAP: " + seciliUrun[0];
        document.getElementById('detay-adres').innerText = seciliUrun[2];
        document.getElementById('detay-stok').innerText = seciliUrun[3];
        document.getElementById('detail-image-panel').style.display = "none";
        document.getElementById('btn-toggle-img').innerText = "üñºÔ∏è G√ñRSELƒ∞ G√ñSTER";
        document.getElementById('detail-frame').src = `https://www.bing.com/images/search?q=${encodeURIComponent(seciliUrun[1])}`;
        showPage('page-detail');
    }

    function makineAramaYap() {
        const query = trNormalize(document.getElementById('action-machine-search').value);
        const resultsDiv = document.getElementById('machine-results');
        if(!query) { resultsDiv.innerHTML = ""; return; }
        
        const filtered = makineler.filter(m => trNormalize(m.join(" ")).includes(query));
        
        resultsDiv.innerHTML = filtered.slice(0, 6).map(m => `
            <div class="product-card" style="padding:16px; border-left: 6px solid var(--valeo-blue); margin-bottom:8px;" onclick="selectMachine('${m[0]}','${m[1]}')">
                <div style="font-size:14px; color:var(--text-main); font-weight:800;">${m[0]}</div>
                <div style="font-size:12px; color:var(--text-sub); margin-top:3px;">${m[1]}</div>
            </div>`).join('');
    }

    function selectMachine(no, ad) {
        seciliMakina = { no, ad };
        document.getElementById('selected-machine-text').innerText = no + " - " + ad;
        document.getElementById('selected-machine-box').style.display = 'block';
        document.getElementById('machine-results').innerHTML = "";
        document.getElementById('action-machine-search').value = "";
        updateButtons();
    }

    function goToAction() {
        seciliMakina = null; document.getElementById('islem-adet').value = 0;
        document.getElementById('selected-machine-box').style.display = 'none';
        document.getElementById('machine-results').innerHTML = "";
        document.getElementById('action-machine-search').value = "";
        updateButtons(); showPage('page-action');
    }

    function adetDegistir(d) {
        let v = parseInt(document.getElementById('islem-adet').value) + d;
        if(v < 0) v = 0;
        document.getElementById('islem-adet').value = v;
        updateButtons();
    }

    function updateButtons() {
        const hasAdet = parseInt(document.getElementById('islem-adet').value) > 0;
        document.getElementById('btn-dusum').disabled = !(seciliMakina && hasAdet);
        document.getElementById('btn-talep').disabled = !(seciliMakina && hasAdet);
    }

    async function kaydet(islem, adet) {
        const veri = { sap: seciliUrun[0], ad: seciliUrun[1], adet: adet, islem: islem, makina: seciliMakina.no, kullanici: localStorage.getItem('depoUser'), timestamp: new Date().toISOString() };
        if (!navigator.onLine) {
            let q = getQueue(); q.push(veri); setQueue(q);
            showSuccessModal(true); return;
        }
        document.getElementById('loading-overlay').style.display = 'flex';
        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(veri) });
            document.getElementById('loading-overlay').style.display = 'none';
            showSuccessModal(false);
        } catch (e) { 
            let q = getQueue(); q.push(veri); setQueue(q);
            document.getElementById('loading-overlay').style.display = 'none';
            showSuccessModal(true);
        }
    }

    async function gecmisGoster() {
        showPage('page-history');
        document.getElementById('dropdown').style.display = 'none';
        if(!navigator.onLine) { document.getElementById('history-body').innerHTML = '<tr><td colspan="5">ƒ∞nternet gerekli.</td></tr>'; return; }
        try {
            const res = await fetch(GECMIS_URL); const csv = await res.text();
            const data = XLSX.utils.sheet_to_json(XLSX.read(csv, {type:'string'}).Sheets.Sheet1, {header: 1});
            const rows = data.slice(1).reverse().slice(0, 40); 
            document.getElementById('history-body').innerHTML = rows.map(row => `
                <tr><td><b>${row[0]}</b></td><td>${row[3]}</td><td style="color:${row[4] === 'STOKTAN D√ú≈û√úM' ? 'var(--danger)' : 'var(--valeo-blue)'}">${row[4] === 'STOKTAN D√ú≈û√úM' ? 'D√º≈ü√ºm' : 'Talep'}</td><td>${row[5]}</td><td>${row[6]}</td></tr>`).join('');
        } catch (e) { document.getElementById('history-body').innerHTML = '<tr><td colspan="5">Hata!</td></tr>'; }
    }

    function girisYap() {
        const u = document.getElementById('user-input').value.trim().toLowerCase();
        const p = document.getElementById('pass-input').value.trim();
        const found = kullanicilar.find(row => row[0]?.toString().toLowerCase() === u && row[1]?.toString() === p);
        if (found) { localStorage.setItem('depoUser', u); showPage('page-search'); } 
        else { alert("Hatalƒ± giri≈ü!"); }
    }

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        document.getElementById(pageId).classList.add('active-page');
        document.getElementById('main-top-bar').style.display = (pageId === 'page-login') ? 'none' : 'flex';
        document.getElementById('btn-back').style.display = (pageId === 'page-login' || pageId === 'page-search') ? 'none' : 'block';
    }

    function goBack() {
        if (document.getElementById('page-detail').classList.contains('active-page')) showPage('page-search');
        else if (document.getElementById('page-action').classList.contains('active-page')) showPage('page-detail');
        else if (document.getElementById('page-history').classList.contains('active-page')) showPage('page-search');
    }

    function toggleImage() {
        const panel = document.getElementById('detail-image-panel');
        panel.style.display = panel.style.display === "none" ? "block" : "none";
        document.getElementById('btn-toggle-img').innerText = panel.style.display === "none" ? "üñºÔ∏è G√ñRSELƒ∞ G√ñSTER" : "‚úñ G√ñRSELƒ∞ Gƒ∞ZLE";
    }

    function toggleMenu(e) { e.stopPropagation(); const d = document.getElementById('dropdown'); d.style.display = d.style.display === 'block' ? 'none' : 'block'; }
    function closeMenuOutside() { document.getElementById('dropdown').style.display = 'none'; }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
    function guvenliCikis() { localStorage.removeItem('depoUser'); location.reload(); }

    window.onload = async () => {
        // HAFIZADAKƒ∞ VERƒ∞LERƒ∞ √ñNCE Y√úKLE (√áEVRƒ∞MDI≈ûI √áALI≈ûABƒ∞LMEK ƒ∞√áƒ∞N)
        urunler = JSON.parse(localStorage.getItem('cached_urunler') || '[]');
        makineler = JSON.parse(localStorage.getItem('cached_makineler') || '[]');
        kullanicilar = JSON.parse(localStorage.getItem('cached_kullanicilar') || '[]');

        if (localStorage.getItem('depoUser')) showPage('page-search');
        updateOnlineStatus();

        if(navigator.onLine) {
            try {
                const [uRes, pRes, mRes] = await Promise.all([fetch(USER_URL).then(r => r.text()), fetch(URUN_URL).then(r => r.text()), fetch(MAKINA_URL).then(r => r.text())]);
                const parseCSV = (d) => XLSX.utils.sheet_to_json(XLSX.read(d, {type:'string'}).Sheets.Sheet1, {header: 1});
                
                kullanicilar = parseCSV(uRes).slice(1); 
                urunler = parseCSV(pRes).slice(1).filter(r => r.length > 0); 
                makineler = parseCSV(mRes).slice(1);
                
                // G√úNCEL VERƒ∞Yƒ∞ √áEVRƒ∞MDI≈ûI KULLANIM ƒ∞√áƒ∞N YEDEKLE
                localStorage.setItem('cached_urunler', JSON.stringify(urunler)); 
                localStorage.setItem('cached_makineler', JSON.stringify(makineler));
                localStorage.setItem('cached_kullanicilar', JSON.stringify(kullanicilar));
            } catch (e) { console.error("Veri g√ºncellenemedi, hafƒ±zadaki veriler kullanƒ±lƒ±yor."); }
        }
    };
</script>
</body>
</html>
