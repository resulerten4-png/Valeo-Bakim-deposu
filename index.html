<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valeo Bakƒ±m Portalƒ± - V2 PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --valeo-green: #99cc00; 
            --valeo-blue: #0091ff; 
            --valeo-dark: #1a1a1b; 
            --bg-gray: #f8f9fa; 
            --card-bg: #ffffff; 
            --text-main: #2d3436; 
            --text-sub: #636e72; 
            --danger: #ff4757; 
            --shadow: 0 10px 25px rgba(0,0,0,0.08); 
            --border: #edf2f7;
        }
        
        body.dark-mode { 
            --bg-gray: #121212; 
            --card-bg: #1e1e1e; 
            --text-main: #f5f6fa; 
            --text-sub: #b2bec3; 
            --valeo-dark: #000000; 
            --border: #2d3436;
            --shadow: 0 10px 25px rgba(0,0,0,0.4);
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-gray); color: var(--text-main); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; transition: 0.3s; }
        .container { background: var(--card-bg); width: 100%; max-width: 1400px; height: 92vh; border-radius: 24px; box-shadow: var(--shadow); display: flex; flex-direction: column; overflow: hidden; position: relative; margin: 10px; border: 1px solid var(--border); }
        .top-bar { background: var(--valeo-dark); color: white; padding: 18px 30px; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .content { padding: 30px; overflow-y: auto; flex-grow: 1; position: relative; }
        
        input { width: 100%; padding: 16px; margin: 10px 0; border-radius: 12px; border: 2px solid var(--border); background: var(--card-bg); color: var(--text-main); font-size: 15px; box-sizing: border-box; transition: 0.2s; }
        input:focus { border-color: var(--valeo-green); outline: none; }
        
        button { background: var(--valeo-green); color: white; border: none; padding: 18px; border-radius: 14px; font-weight: 700; cursor: pointer; transition: 0.2s; }
        button:disabled { background: #cbd5e0 !important; opacity: 0.6; cursor: not-allowed; }
        
        #search-results, #machine-results { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 15px; }
        .product-card { background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 15px; border-left: 5px solid var(--valeo-green); cursor: pointer; transition: 0.2s; }
        .product-card:hover { transform: translateY(-3px); box-shadow: var(--shadow); }
        
        .page { display: none; height: 100%; flex-direction: column; animation: fadeIn 0.3s; }
        .active-page { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        #detail-image-panel { width: 100%; height: 400px; border-radius: 15px; overflow: hidden; margin-bottom: 15px; border: 1px solid var(--border); display: none; }
        #detail-frame { width: 100%; height: 100%; border: none; }
        
        .stepper { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 25px 0; background: var(--bg-gray); padding: 15px; border-radius: 15px; width: fit-content; margin-left: auto; margin-right: auto; }
        .stepper button { width: 60px; height: 60px; border-radius: 50%; background: var(--valeo-dark); font-size: 24px; padding: 0; }
        #islem-adet { width: 100px; text-align: center; font-size: 32px; font-weight: 800; border: none; background: transparent; color: var(--text-main); }
        
        .dropdown-menu { display: none; position: absolute; right: 30px; top: 70px; background: var(--card-bg); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 50; min-width: 200px; overflow: hidden; border: 1px solid var(--border); }
        .dropdown-menu div { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 15px; }
        
        .machine-selection-box { background: var(--valeo-blue); color: white; padding: 20px; border-radius: 12px; margin: 15px 0; font-weight: bold; font-size: 18px; text-align: center; }
        
        .history-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 20px; }
        .history-table th { background: var(--valeo-dark); color: white; padding: 15px 10px; text-align: left; position: sticky; top: 0; }
        .history-table td { padding: 15px 10px; border-bottom: 1px solid var(--border); }
        
        mark { background: #f1c40f; color: black; padding: 0 2px; border-radius: 3px; }
    </style>
</head>
<body onclick="closeMenuOutside(event)">

<div class="container">
    <div id="main-top-bar" class="top-bar" style="display:none;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div id="btn-back" onclick="goBack()" style="display:none; cursor:pointer; font-size:24px;">‚¨ÖÔ∏è</div>
            <div style="font-size: 16px; font-weight: 800; letter-spacing: 2px;">VALEO PORTAL</div>
        </div>
        <div style="cursor:pointer; font-size: 24px;" onclick="toggleMenu(event)">‚ò∞</div>
        <div id="dropdown" class="dropdown-menu">
            <div onclick="toggleDarkMode()">üåì Karanlƒ±k Mod</div>
            <div onclick="gecmisGoster()">üìã ƒ∞≈ülem Ge√ßmi≈üi</div>
            <div onclick="guvenliCikis()" style="color:var(--danger)">üö™ √áƒ±kƒ±≈ü Yap</div>
        </div>
    </div>

    <div id="page-login" class="page active-page">
        <div class="content" style="text-align:center; justify-content: center; display: flex; flex-direction: column; max-width: 400px; margin: 0 auto;">
            <h1 style="color:var(--valeo-green); font-size:64px; margin:0; font-weight:800;">Valeo</h1>
            <p style="letter-spacing:5px; font-size:12px; opacity:0.6; margin-bottom:40px; font-weight:600;">BAKIM DEPO Sƒ∞STEMƒ∞</p>
            <input type="text" id="user-input" placeholder="Kullanƒ±cƒ± Adƒ±">
            <input type="password" id="pass-input" placeholder="≈ûifre">
            <button onclick="girisYap()" style="width: 100%;">Sƒ∞STEME Gƒ∞Rƒ∞≈û</button>
        </div>
    </div>

    <div id="page-search" class="page">
        <div class="content">
            <h2 style="margin-top:0;">Stok Y√∂netimi</h2>
            <input type="text" id="search-main" placeholder="Malzeme adƒ± veya SAP..." oninput="aramaYap()" style="padding:20px; font-size:18px;">
            <div id="search-results"></div>
        </div>
    </div>

    <div id="page-detail" class="page">
        <div class="content">
            <div id="detail-image-panel"><iframe id="detail-frame" src=""></iframe></div>
            <button id="btn-toggle-img" onclick="toggleImage()" style="background:var(--valeo-dark); margin-bottom:20px; width: auto; padding: 10px 20px;">üñºÔ∏è √úR√úN G√ñRSELƒ∞Nƒ∞ G√ñSTER</button>
            <div style="display: flex; gap: 30px; align-items: flex-start;">
                <div style="flex: 1;">
                    <h2 id="detay-ad" style="margin:0; font-size:32px;"></h2>
                    <div id="detay-sap" style="font-weight:900; color:var(--valeo-green); font-size:24px; margin: 10px 0;"></div>
                </div>
                <div style="background:var(--bg-gray); padding:30px; border-radius:15px; min-width: 300px; border: 1px solid var(--border);">
                    <div style="margin-bottom:15px; font-size: 18px;">üìç <b>Depo Adresi:</b> <span id="detay-adres"></span></div>
                    <div style="font-size: 22px;">üì¶ <b>G√ºncel Stok:</b> <span id="detay-stok" style="font-weight: 800; color: var(--valeo-blue);"></span> ADET</div>
                </div>
            </div>
            <button onclick="goToAction()" style="margin-top:40px; background:var(--valeo-blue); width: 100%; font-size: 20px;">BU √úR√úN√ú SE√á</button>
        </div>
    </div>

    <div id="page-action" class="page">
        <div class="content">
            <div style="max-width: 800px; margin: 0 auto;">
                <h3 style="text-align: center;">ƒ∞≈ülem Detaylarƒ±</h3>
                <label style="font-weight:bold; color:var(--text-sub);">1. MAKƒ∞NA SE√áƒ∞Mƒ∞ (Sayfa 4)</label>
                <input type="text" id="action-machine-search" placeholder="Makina ara..." oninput="makineAramaYap()">
                <div id="machine-results"></div>
                <div id="selected-machine-box" class="machine-selection-box" style="display:none;"></div>
                
                <div style="margin-top:40px;">
                    <label style="font-weight:bold; color:var(--text-sub); display: block; text-align: center;">2. ƒ∞≈ûLEM ADEDƒ∞</label>
                    <div class="stepper">
                        <button onclick="adetDegistir(-1)">-</button>
                        <input type="number" id="islem-adet" value="0" readonly>
                        <button onclick="adetDegistir(1)">+</button>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                    <button id="btn-dusum" style="background:var(--danger);" onclick="finalOnay('STOKTAN D√ú≈û√úM')" disabled>üìâ STOKTAN D√ú≈û√úM</button>
                    <button id="btn-talep" style="background:var(--valeo-dark);" onclick="finalOnay('Sƒ∞PARƒ∞≈û TALEBƒ∞')" disabled>üõí Sƒ∞PARƒ∞≈û TALEBƒ∞</button>
                </div>
            </div>
        </div>
    </div>

    <div id="page-history" class="page">
        <div class="content">
            <h2 style="margin-top:0;">ƒ∞≈ülem Ge√ßmi≈üi (Son 40 Kayƒ±t)</h2>
            <div style="background: var(--card-bg); border-radius: 15px; border: 1px solid var(--border); overflow-x: auto;">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>SAP Kodu</th>
                            <th>Malzeme Adƒ±</th>
                            <th>Adet</th>
                            <th>ƒ∞≈ülem T√ºr√º</th>
                            <th>Makina No</th>
                            <th>Kullanƒ±cƒ±</th>
                            <th>Yetkili</th>
                        </tr>
                    </thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxGCCJo34saMWKeLiFKUaWZzZh3k4sIoAiRYZ_oV7rNPWtf60UaXJUKWIn0g27RRMsIRg/exec';
    const URUN_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBkW/pub?gid=1489941403&single=true&output=csv';
    const USER_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBkW/pub?gid=1584268931&single=true&output=csv';
    const MAKINA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBkW/pub?gid=1658888580&single=true&output=csv';
    const GECMIS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBkW/pub?gid=185766952&single=true&output=csv';

    let urunler = [], makineler = [], kullanicilar = [], seciliUrun = null, seciliMakina = null;

    function trNormalize(text) {
        if (!text) return "";
        return text.toString().replace(/ƒ∞/g, 'i').replace(/I/g, 'i').toLowerCase()
            .replace(/ƒü/g, 'g').replace(/√º/g, 'u').replace(/≈ü/g, 's')
            .replace(/ƒ±/g, 'i').replace(/√∂/g, 'o').replace(/√ß/g, 'c').trim();
    }

    // TARƒ∞H D√úZELTME FONKSƒ∞YONU: Excel'in sayƒ±sal tarihini okunaklƒ± hale getirir
    function formatExcelDate(serial) {
        if (!serial) return "-";
        if (isNaN(serial) || serial < 1000) return serial; // Zaten d√ºzg√ºn tarihler i√ßin
        const dateObj = XLSX.SSF.parse_date_code(serial);
        const d = new Date(dateObj.y, dateObj.m - 1, dateObj.d, dateObj.H, dateObj.M);
        return d.toLocaleString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    async function kaydet(islem, adet) {
        const currentUser = localStorage.getItem('depoUser');
        const userRow = kullanicilar.find(r => r[0]?.toString().toLowerCase() === currentUser);
        
        // D√úZELTME: Sayfa 3 F S√ºtunu (index 5) Kullanƒ±cƒ±, H S√ºtunu (index 7) Yetkili
        const islemYapan = userRow ? userRow[5] : currentUser; 
        const onayYetkilisi = userRow ? userRow[7] : "-"; 

        const veri = { 
            tarih: new Date().toLocaleString('tr-TR'), // T√ºrkiye Tarih Ayarƒ±
            sap: seciliUrun[0], 
            ad: seciliUrun[1], 
            kullanici: islemYapan, 
            adet: adet, 
            islem: islem, 
            makina: seciliMakina.no, // Sayfa 4'ten alƒ±nan No
            yetkili: onayYetkilisi 
        };

        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(veri) });
            alert("ƒ∞≈ûLEM BA≈ûARIYLA KAYDEDƒ∞LDƒ∞!"); showPage('page-search');
        } catch (e) { alert("Hata olu≈ütu!"); }
    }

    async function gecmisGoster() {
        showPage('page-history');
        document.getElementById('dropdown').style.display = 'none';
        const res = await fetch(GECMIS_URL);
        const csvText = await res.text();
        const data = XLSX.utils.sheet_to_json(XLSX.read(csvText, {type:'string'}).Sheets.Sheet1, {header: 1});
        const rows = data.slice(1).reverse().slice(0, 40);
        
        // Tablo Sƒ±ralamasƒ± ve Tarih D√ºzeltmesi (G√∂rseldeki s√ºtun d√ºzenine g√∂re)
        document.getElementById('history-body').innerHTML = rows.map(row => `
            <tr>
                <td>${formatExcelDate(row[6])}</td>
                <td><b>${row[0] || '-'}</b></td>
                <td>${row[1] || '-'}</td>
                <td>${row[3] || '0'}</td>
                <td>${row[4] || '-'}</td>
                <td>${row[5] || '-'}</td>
                <td>${row[2] || '-'}</td>
                <td>${row[7] || '-'}</td>
            </tr>`).join('');
    }

    // Arama, Detay ve UI Fonksiyonlarƒ± (Hƒ∞√áBƒ∞R ≈ûEY Sƒ∞Lƒ∞NMEDEN KORUNDU)
    function aramaYap() {
        const query = trNormalize(document.getElementById('search-main').value);
        const resultsContainer = document.getElementById('search-results');
        if (!query) { resultsContainer.innerHTML = ""; return; }
        const filtered = urunler.filter(u => trNormalize(u[0] + " " + u[1]).includes(query));
        resultsContainer.innerHTML = filtered.slice(0, 30).map(u => `
            <div class="product-card" onclick="openDetail('${u[0]}')">
                <div style="font-weight:800; color:var(--valeo-green);">SAP: ${u[0]}</div>
                <div style="font-size:14px;">${u[1]}</div>
            </div>`).join('');
    }

    function openDetail(sap) {
        seciliUrun = urunler.find(u => u[0].toString() === sap.toString());
        document.getElementById('detay-ad').innerText = seciliUrun[1];
        document.getElementById('detay-sap').innerText = "SAP: " + seciliUrun[0];
        document.getElementById('detay-adres').innerText = seciliUrun[2];
        document.getElementById('detay-stok').innerText = seciliUrun[3];
        document.getElementById('detail-image-panel').style.display = "none";
        document.getElementById('detail-frame').src = `https://www.bing.com/images/search?q=${encodeURIComponent(seciliUrun[1])}`;
        showPage('page-detail');
    }

    function makineAramaYap() {
        const query = trNormalize(document.getElementById('action-machine-search').value);
        if(!query) { document.getElementById('machine-results').innerHTML = ""; return; }
        const filtered = makineler.filter(m => trNormalize(m[0] + " " + m[1]).includes(query));
        document.getElementById('machine-results').innerHTML = filtered.slice(0, 6).map(m => `
            <div class="product-card" style="padding:15px; border-left-color:var(--valeo-blue);" onclick="selectMachine('${m[0]}','${m[1]}')">
                <b>${m[0]}</b><br><small>${m[1]}</small>
            </div>`).join('');
    }

    function selectMachine(no, ad) {
        seciliMakina = { no, ad };
        document.getElementById('selected-machine-box').innerText = "SE√áƒ∞LEN MAKƒ∞NA: " + no;
        document.getElementById('selected-machine-box').style.display = 'block';
        document.getElementById('machine-results').innerHTML = "";
        updateButtons();
    }

    function showPage(p) { 
        document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active-page')); 
        document.getElementById(p).classList.add('active-page'); 
        document.getElementById('main-top-bar').style.display = (p === 'page-login') ? 'none' : 'flex'; 
        document.getElementById('btn-back').style.display = (p === 'page-login' || p === 'page-search') ? 'none' : 'block'; 
    }

    function girisYap() { 
        const u = document.getElementById('user-input').value.trim().toLowerCase(); 
        const p = document.getElementById('pass-input').value.trim(); 
        const found = kullanicilar.find(r => r[0]?.toString().toLowerCase() === u && r[1]?.toString() === p); 
        if (found) { localStorage.setItem('depoUser', u); showPage('page-search'); } else { alert("Hata!"); } 
    }

    function goBack() { 
        if (document.getElementById('page-detail').classList.contains('active-page')) showPage('page-search'); 
        else if (document.getElementById('page-action').classList.contains('active-page')) showPage('page-detail'); 
        else if (document.getElementById('page-history').classList.contains('active-page')) showPage('page-search'); 
    }

    function toggleImage() { 
        const panel = document.getElementById('detail-image-panel'); 
        panel.style.display = (panel.style.display === "none") ? "block" : "none"; 
    }

    function goToAction() { 
        seciliMakina = null; document.getElementById('islem-adet').value = 0; 
        document.getElementById('selected-machine-box').style.display = 'none'; 
        updateButtons(); showPage('page-action'); 
    }

    function adetDegistir(d) { 
        let v = parseInt(document.getElementById('islem-adet').value) + d; 
        if(v >= 0) document.getElementById('islem-adet').value = v; 
        updateButtons(); 
    }

    function updateButtons() { 
        const hasAdet = parseInt(document.getElementById('islem-adet').value) > 0; 
        document.getElementById('btn-dusum').disabled = !(seciliMakina && hasAdet); 
        document.getElementById('btn-talep').disabled = !(seciliMakina && hasAdet); 
    }

    function finalOnay(i) { if(confirm(i + " onaylƒ±yor musunuz?")) kaydet(i, document.getElementById('islem-adet').value); }
    function toggleMenu(e) { e.stopPropagation(); const d = document.getElementById('dropdown'); d.style.display = (d.style.display === 'block') ? 'none' : 'block'; }
    function closeMenuOutside() { document.getElementById('dropdown').style.display = 'none'; }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
    function guvenliCikis() { localStorage.removeItem('depoUser'); location.reload(); }

    window.onload = async () => {
        if (localStorage.getItem('depoUser')) showPage('page-search');
        try {
            const [uRes, pRes, mRes] = await Promise.all([
                fetch(USER_URL).then(r => r.text()), fetch(URUN_URL).then(r => r.text()), fetch(MAKINA_URL).then(r => r.text())
            ]);
            const parseCSV = (data) => XLSX.utils.sheet_to_json(XLSX.read(data, {type:'string'}).Sheets.Sheet1, {header: 1});
            kullanicilar = parseCSV(uRes).slice(1);
            urunler = parseCSV(pRes).slice(1);
            makineler = parseCSV(mRes).slice(1);
        } catch (e) { console.error(e); }
    };
</script>
</body>
</html>
