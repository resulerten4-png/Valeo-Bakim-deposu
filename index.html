<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valeo BakÄ±m PortalÄ± - V2 PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --valeo-green: #99cc00; 
            --valeo-blue: #0091ff; 
            --valeo-dark: #1a1a1b; 
            --bg-gray: #f4f7f6; 
            --card-bg: #ffffff; 
            --text-main: #2d3436; 
            --text-sub: #57606f; 
            --danger: #ff4757; 
            --shadow: 0 10px 25px rgba(0,0,0,0.05);
            --border: #edf2f7;
        }

        body.dark-mode { 
            --bg-gray: #0f0f0f; 
            --card-bg: #1e1e1e; 
            --text-main: #ffffff; 
            --text-sub: #ced6e0; 
            --valeo-dark: #000000;
            --border: #333333;
            --shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-gray); color: var(--text-main); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; transition: 0.3s; }
        .container { background: var(--card-bg); width: 100%; max-width: 450px; height: 92vh; border-radius: 24px; box-shadow: var(--shadow); display: flex; flex-direction: column; overflow: hidden; position: relative; margin: 10px; border: 1px solid var(--border); }
        .top-bar { background: var(--valeo-dark); color: white; padding: 18px; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .content { padding: 20px; overflow-y: auto; flex-grow: 1; }
        input { width: 100%; padding: 16px; margin: 10px 0; border-radius: 12px; border: 2px solid var(--border); background: var(--card-bg); color: var(--text-main); font-size: 15px; box-sizing: border-box; }
        input:focus { border-color: var(--valeo-green); outline: none; }
        button { background: var(--valeo-green); color: white; border: none; padding: 18px; border-radius: 14px; font-weight: 700; cursor: pointer; width: 100%; transition: 0.2s; }
        button:disabled { background: #95a5a6 !important; opacity: 0.5; cursor: not-allowed; }
        .product-card { background: var(--card-bg); border: 1px solid var(--border); margin-bottom: 12px; padding: 15px; border-radius: 15px; border-left: 5px solid var(--valeo-green); cursor: pointer; }
        .page { display: none; height: 100%; flex-direction: column; animation: fadeIn 0.3s; }
        .active-page { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        mark { background: #f1c40f; color: #000; padding: 0 2px; border-radius: 3px; font-weight: bold; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; }
        .history-table th { background: var(--valeo-dark); color: white; padding: 10px 5px; text-align: left; position: sticky; top: 0; }
        .history-table td { padding: 10px 5px; border-bottom: 1px solid var(--border); color: var(--text-main); }
        .dropdown-menu { display: none; position: absolute; right: 15px; top: 60px; background: var(--card-bg); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 50; min-width: 170px; border: 1px solid var(--border); }
        .dropdown-menu div { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border); color: var(--text-main); }
    </style>
</head>
<body onclick="closeMenuOutside(event)">

<div class="container">
    <div id="main-top-bar" class="top-bar" style="display:none;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div id="btn-back" onclick="goBack()" style="display:none; cursor:pointer; font-size:18px;">â¬…ï¸</div>
            <div style="font-size: 12px; font-weight: 800; letter-spacing: 1px;">VALEO PORTAL</div>
        </div>
        <div style="cursor:pointer; font-size: 20px;" onclick="toggleMenu(event)">â˜°</div>
        <div id="dropdown" class="dropdown-menu">
            <div onclick="toggleDarkMode()">ğŸŒ“ KaranlÄ±k Mod</div>
            <div onclick="gecmisGoster()">ğŸ“‹ Ä°ÅŸlem GeÃ§miÅŸi</div>
            <div onclick="guvenliCikis()" style="color:var(--danger)">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</div>
        </div>
    </div>

    <div id="page-login" class="page active-page">
        <div onclick="toggleDarkMode()" style="position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer;">ğŸŒ“</div>
        <div class="content" style="text-align:center; justify-content: center; display: flex; flex-direction: column;">
            <h1 style="color:var(--valeo-green); font-size:48px; margin:0; font-weight:800;">Valeo</h1>
            <p style="letter-spacing:3px; font-size:10px; opacity:0.6; margin-bottom:40px; font-weight:600; color:var(--text-main);">BAKIM DEPO SÄ°STEMÄ°</p>
            <input type="text" id="user-input" placeholder="KullanÄ±cÄ± AdÄ±">
            <input type="password" id="pass-input" placeholder="Åifre">
            <button onclick="girisYap()">SÄ°STEME GÄ°RÄ°Å</button>
        </div>
    </div>

    <div id="page-search" class="page">
        <div class="content">
            <h3 style="margin-top:0; color:var(--text-main);">Stok Ara</h3>
            <input type="text" id="search-main" placeholder="Malzeme adÄ± veya SAP..." oninput="aramaYap()">
            <div id="search-results"></div>
        </div>
    </div>

    <div id="page-detail" class="page">
        <div class="content">
            <div id="detail-image-panel" style="display:none; width:100%; height:200px; margin-bottom:15px; border-radius:15px; overflow:hidden; border:1px solid var(--border);">
                <iframe id="detail-frame" style="width:100%; height:100%; border:none;" src=""></iframe>
            </div>
            <button id="btn-toggle-img" onclick="toggleImage()" style="background:var(--valeo-dark); margin-bottom:15px; padding:10px; font-size:12px; width:auto;">ğŸ–¼ï¸ GÃ–RSELÄ° GÃ–STER</button>
            <h2 id="detay-ad" style="margin:5px 0; font-size:22px; color:var(--text-main);"></h2>
            <div id="detay-sap" style="font-weight:900; color:var(--valeo-green); font-size:18px; margin-bottom:15px;"></div>
            <div style="background:var(--bg-gray); padding:15px; border-radius:12px; font-size:14px; color:var(--text-main);">
                <div style="margin-bottom:8px;">ğŸ“ <b>Adres:</b> <span id="detay-adres"></span></div>
                <div>ğŸ“¦ <b>Stok:</b> <span id="detay-stok"></span> ADET</div>
            </div>
            <button onclick="goToAction()" style="margin-top:25px; background:var(--valeo-blue);">BU ÃœRÃœNÃœ SEÃ‡</button>
        </div>
    </div>

    <div id="page-action" class="page">
        <div class="content">
            <label style="font-weight:bold; font-size:12px; color:var(--text-sub);">MAKÄ°NA SEÃ‡Ä°MÄ°</label>
            <input type="text" id="action-machine-search" placeholder="Makina ara..." oninput="makineAramaYap()">
            <div id="machine-results" style="max-height:150px; overflow-y:auto;"></div>
            <div id="selected-machine-box" style="display:none; background:var(--valeo-blue); color:white; padding:12px; border-radius:10px; margin:10px 0; font-weight:bold;"></div>
            <div style="margin-top:20px; text-align:center;">
                <label style="font-weight:bold; font-size:12px; color:var(--text-sub);">Ä°ÅLEM ADEDÄ°</label>
                <div style="display:flex; align-items:center; justify-content:center; gap:15px; margin:20px 0; background:var(--bg-gray); padding:10px; border-radius:15px;">
                    <button style="width:50px; height:50px; border-radius:50%; background:var(--valeo-dark);" onclick="adetDegistir(-1)">-</button>
                    <input type="number" id="islem-adet" value="0" readonly style="width:70px; text-align:center; font-size:24px; border:none; background:transparent; color:var(--text-main); font-weight:800;">
                    <button style="width:50px; height:50px; border-radius:50%; background:var(--valeo-dark);" onclick="adetDegistir(1)">+</button>
                </div>
            </div>
            <button id="btn-dusum" style="background:var(--danger); margin-top:10px;" onclick="finalOnay('STOKTAN DÃœÅÃœM')" disabled>ğŸ“‰ STOKTAN DÃœÅÃœM</button>
            <button id="btn-talep" style="background:var(--valeo-dark); margin-top:10px;" onclick="finalOnay('SÄ°PARÄ°Å TALEBÄ°')" disabled>ğŸ›’ SÄ°PARÄ°Å TALEBÄ°</button>
        </div>
    </div>

    <div id="page-history" class="page">
        <div class="content">
            <h3 style="margin-top:0; color:var(--text-main);">Son Ä°ÅŸlemler</h3>
            <div style="overflow-x: auto;">
                <table class="history-table">
                    <thead><tr><th>SAP</th><th>ADET</th><th>TÄ°P</th><th>PERS</th><th>TARÄ°H</th></tr></thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxGCCJo34saMWKeLiFKUaWZzZh3k4sIoAiRYZ_oV7rNPWtf60UaXJUKWIn0g27RRMsIRg/exec';
    const URUN_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBzW/pub?gid=1489941403&single=true&output=csv';
    const USER_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBzW/pub?gid=1584268931&single=true&output=csv';
    const MAKINA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBzW/pub?gid=1658888580&single=true&output=csv';
    const GECMIS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBzW/pub?gid=185766952&single=true&output=csv';

    let urunler = [], makineler = [], kullanicilar = [], seciliUrun = null, seciliMakina = null;

    function trNormalize(text) {
        if (!text) return "";
        return text.toString().replace(/Ä°/g, 'i').replace(/I/g, 'i').toLowerCase()
            .replace(/ÄŸ/g, 'g').replace(/Ã¼/g, 'u').replace(/ÅŸ/g, 's')
            .replace(/Ä±/g, 'i').replace(/Ã¶/g, 'o').replace(/Ã§/g, 'c').trim();
    }

    function highlight(text, terms) {
        if (!terms || terms.length === 0) return text;
        let h = text;
        terms.forEach(t => {
            const regex = new RegExp(`(${t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            h = h.replace(regex, '<mark>$1</mark>');
        });
        return h;
    }

    function aramaYap() {
        const raw = document.getElementById('search-main').value;
        const res = document.getElementById('search-results');
        if (!raw.trim()) { res.innerHTML = ""; return; }
        const terms = trNormalize(raw).split(/\s+/).filter(t => t.length > 0);
        const filtered = urunler.filter(u => terms.every(t => trNormalize((u[0]||"") + " " + (u[1]||"")).includes(t)));
        res.innerHTML = filtered.slice(0, 25).map(u => `
            <div class="product-card" onclick="openDetail('${u[0]}')">
                <div style="font-weight:900; color:var(--text-main);">SAP: ${highlight(String(u[0]), terms)}</div>
                <div style="font-weight:700; color:var(--text-main); font-size:14px;">${highlight(String(u[1]), terms)}</div>
                <div style="font-size:12px; color:var(--text-sub); margin-top:5px;">ğŸ“ ${u[2]||"-"} | ğŸ“¦ ${u[3]||"0"} ADET</div>
            </div>`).join('');
    }

    function openDetail(sap) {
        seciliUrun = urunler.find(u => u[0].toString() === sap.toString());
        document.getElementById('detay-ad').innerText = seciliUrun[1];
        document.getElementById('detay-sap').innerText = "SAP: " + seciliUrun[0];
        document.getElementById('detay-adres').innerText = seciliUrun[2];
        document.getElementById('detay-stok').innerText = seciliUrun[3];
        document.getElementById('detail-image-panel').style.display = "none";
        document.getElementById('detail-frame').src = `https://www.bing.com/images/search?q=${encodeURIComponent(seciliUrun[1])}`;
        showPage('page-detail');
    }

    async function gecmisGoster() {
        showPage('page-history');
        document.getElementById('dropdown').style.display = 'none';
        document.getElementById('history-body').innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">YÃ¼kleniyor...</td></tr>';
        try {
            const r = await fetch(GECMIS_URL);
            const csv = await r.text();
            const wb = XLSX.read(csv, {type:'string'});
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header: 1});
            const rows = data.slice(1).reverse().slice(0, 35); 
            document.getElementById('history-body').innerHTML = rows.map(row => {
                let fT = "-";
                if (row[6]) {
                    try {
                        if (!isNaN(row[6])) { fT = XLSX.SSF.format('dd.mm.yyyy', row[6]); }
                        else { fT = row[6].split(' ')[0]; }
                    } catch(e) { fT = row[6]; }
                }
                return `<tr>
                    <td><b>${row[0]||'-'}</b></td>
                    <td>${row[3]||'0'}</td>
                    <td style="color:${row[4]==='STOKTAN DÃœÅÃœM'?'var(--danger)':'var(--valeo-blue)'}">${row[4]==='STOKTAN DÃœÅÃœM'?'DÃ¼ÅŸÃ¼m':'Talep'}</td>
                    <td>${row[5]||'-'}</td>
                    <td style="opacity:0.7;">${fT}</td>
                </tr>`;
            }).join('');
        } catch (e) { document.getElementById('history-body').innerHTML = '<tr><td colspan="5">Veri yÃ¼klenemedi.</td></tr>'; }
    }

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        document.getElementById(id).classList.add('active-page');
        document.getElementById('main-top-bar').style.display = (id === 'page-login') ? 'none' : 'flex';
        document.getElementById('btn-back').style.display = (id === 'page-login' || id === 'page-search') ? 'none' : 'block';
    }

    function girisYap() {
        const u = document.getElementById('user-input').value.trim().toLowerCase();
        const p = document.getElementById('pass-input').value.trim();
        if (kullanicilar.find(r => r[0]?.toString().toLowerCase() === u && r[1]?.toString() === p)) {
            localStorage.setItem('depoUser', u); showPage('page-search');
        } else { alert("KullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±!"); }
    }

    function goBack() {
        if (document.getElementById('page-detail').classList.contains('active-page')) showPage('page-search');
        else if (document.getElementById('page-action').classList.contains('active-page')) showPage('page-detail');
        else if (document.getElementById('page-history').classList.contains('active-page')) showPage('page-search');
    }

    function toggleImage() {
        const p = document.getElementById('detail-image-panel');
        p.style.display = p.style.display === "none" ? "block" : "none";
        document.getElementById('btn-toggle-img').innerText = p.style.display === "none" ? "ğŸ–¼ï¸ GÃ–RSELÄ° GÃ–STER" : "âœ– GÄ°ZLE";
    }

    function goToAction() {
        seciliMakina = null; document.getElementById('islem-adet').value = 0;
        document.getElementById('selected-machine-box').style.display = 'none';
        document.getElementById('action-machine-search').value = "";
        document.getElementById('machine-results').innerHTML = "";
        updateButtons(); showPage('page-action');
    }

    function makineAramaYap() {
        const q = trNormalize(document.getElementById('action-machine-search').value);
        if(!q) { document.getElementById('machine-results').innerHTML = ""; return; }
        const f = makineler.filter(m => trNormalize(m.join(" ")).includes(q));
        document.getElementById('machine-results').innerHTML = f.slice(0, 5).map(m => `
            <div class="product-card" style="padding:10px; border-left-color:var(--valeo-blue);" onclick="selectMachine('${m[0]}','${m[1]}')">
                <div style="font-size:13px; color:var(--text-main);"><b>${m[0]}</b> - ${m[1]}</div>
            </div>`).join('');
    }

    function selectMachine(no, ad) {
        seciliMakina = { no, ad };
        document.getElementById('selected-machine-box').innerText = "âœ… SEÃ‡Ä°LDÄ°: " + no;
        document.getElementById('selected-machine-box').style.display = 'block';
        document.getElementById('machine-results').innerHTML = "";
        updateButtons();
    }

    function adetDegistir(d) {
        let v = Math.max(0, parseInt(document.getElementById('islem-adet').value) + d);
        document.getElementById('islem-adet').value = v;
        updateButtons();
    }

    function updateButtons() {
        const ok = (seciliMakina && parseInt(document.getElementById('islem-adet').value) > 0);
        document.getElementById('btn-dusum').disabled = !ok;
        document.getElementById('btn-talep').disabled = !ok;
    }

    function finalOnay(i) { if(confirm(i + " onaylÄ±yor musunuz?")) kaydet(i, document.getElementById('islem-adet').value); }

    async function kaydet(i, a) {
        const v = { sap: seciliUrun[0], ad: seciliUrun[1], adet: a, islem: i, makina: seciliMakina.no, kullanici: localStorage.getItem('depoUser') };
        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(v) });
            alert("Ä°ÅLEM BAÅARILI!"); showPage('page-search');
        } catch (e) { alert("Bir hata oluÅŸtu!"); }
    }

    function toggleMenu(e) { e.stopPropagation(); const d = document.getElementById('dropdown'); d.style.display = d.style.display === 'block' ? 'none' : 'block'; }
    function closeMenuOutside() { document.getElementById('dropdown').style.display = 'none'; }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
    function guvenliCikis() { localStorage.removeItem('depoUser'); location.reload(); }

    window.onload = async () => {
        if (localStorage.getItem('depoUser')) showPage('page-search');
        try {
            const [u, p, m] = await Promise.all([fetch(USER_URL).then(r=>r.text()), fetch(URUN_URL).then(r=>r.text()), fetch(MAKINA_URL).then(r=>r.text())]);
            const parse = (d) => {
                const workbook = XLSX.read(d, {type:'string'});
                return XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
            };
            kullanicilar = parse(u).slice(1); urunler = parse(p).slice(1).filter(r=>r.length>0); makineler = parse(m).slice(1);
        } catch (e) { console.error("Veri Ã§ekme hatasÄ±:", e); }
    };
</script>
</body>
</html>
