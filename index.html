<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valeo Bakƒ±m Portalƒ± - V2 PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --valeo-green: #99cc00; 
            --valeo-blue: #0091ff; 
            --valeo-dark: #1a1a1b; 
            --bg-gray: #f8f9fa; 
            --card-bg: #ffffff; 
            --text-main: #2d3436; 
            --text-sub: #636e72; 
            --danger: #ff4757; 
            --warning: #f1c40f;
            --shadow: 0 10px 25px rgba(0,0,0,0.08); 
            --border: #edf2f7;
        }
        
        body.dark-mode { 
            --bg-gray: #121212; 
            --card-bg: #1e1e1e; 
            --text-main: #f5f6fa; 
            --text-sub: #b2bec3; 
            --valeo-dark: #000000; 
            --border: #2d3436;
            --shadow: 0 10px 25px rgba(0,0,0,0.4);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-gray); 
            color: var(--text-main); 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            transition: 0.3s; 
            padding: 20px; 
            box-sizing: border-box; 
        }
        
        .container { 
            background: var(--card-bg); 
            width: 100%; 
            max-width: 500px; 
            height: 90vh; 
            border-radius: 24px; 
            box-shadow: var(--shadow); 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            position: relative; 
            border: 1px solid var(--border); 
            transition: max-width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (min-width: 768px) {
            .container { max-width: 800px; }
            #search-results { 
                display: grid !important; 
                grid-template-columns: 1fr 1fr; 
                gap: 15px; 
            }
            .product-card { margin-bottom: 0 !important; }
        }

        @media (min-width: 1200px) {
            .container { max-width: 1100px; }
            #search-results { 
                grid-template-columns: 1fr 1fr 1fr; 
            }
        }

        /* HIZLI G√ñRSEL G√ñR√úNT√úLEYƒ∞Cƒ∞ */
        #quick-image-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        .quick-image-container {
            width: 90%;
            height: 80%;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        .quick-image-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--danger);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10001;
        }

        .modal-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000; justify-content: center; align-items: center; }
        .modal-card { background: var(--card-bg); width: 85%; max-width: 350px; border-radius: 24px; padding: 30px; text-align: center; box-shadow: var(--shadow); animation: modalSlideUp 0.3s ease-out; }
        
        #loading-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.85); z-index: 1000; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        body.dark-mode #loading-overlay { background: rgba(0, 0, 0, 0.85); }

        .top-bar { background: var(--valeo-dark); color: white; padding: 18px 25px; display: flex; justify-content: space-between; align-items: center; z-index: 10; flex-shrink: 0; }
        .content { padding: 25px; overflow-y: auto; flex-grow: 1; position: relative; }
        
        input { width: 100%; padding: 16px; margin: 10px 0; border-radius: 12px; border: 2px solid var(--border); background: var(--card-bg); color: var(--text-main); font-size: 15px; box-sizing: border-box; transition: 0.2s; }
        
        button { background: var(--valeo-green); color: white; border: none; padding: 18px; border-radius: 14px; font-weight: 700; cursor: pointer; width: 100%; transition: 0.2s; }
        
        .product-card { background: var(--card-bg); border: 1px solid var(--border); padding: 18px; border-radius: 18px; border-left: 6px solid var(--valeo-green); cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; justify-content: space-between; position: relative; }
        .product-card:hover { transform: translateY(-3px); box-shadow: var(--shadow); border-color: var(--valeo-green); }
        
        .btn-quick-view { 
            background: var(--valeo-dark); 
            color: white; 
            font-size: 11px; 
            padding: 8px 12px; 
            border-radius: 10px; 
            width: auto; 
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 800;
        }

        .page { display: none; height: 100%; flex-direction: column; animation: fadeIn 0.4s ease; }
        .active-page { display: flex; }
        
        #detail-image-panel { width: 100%; height: 300px; border-radius: 20px; overflow: hidden; margin-bottom: 20px; border: 1px solid var(--border); display: none; }
        #detail-frame { width: 100%; height: 100%; border: none; }
        
        .stepper { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 20px 0; }
        .dropdown-menu { display: none; position: absolute; right: 25px; top: 70px; background: var(--card-bg); border-radius: 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); z-index: 50; min-width: 200px; overflow: hidden; border: 1px solid var(--border); }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .history-table th { background: var(--valeo-dark); color: white; padding: 15px 10px; text-align: left; font-size: 12px; }
        .history-table td { padding: 15px 10px; border-bottom: 1px solid var(--border); font-size: 13px; }
    </style>
</head>
<body onclick="closeMenuOutside(event)">

<div id="quick-image-overlay" onclick="closeQuickImage()">
    <button class="quick-image-close" onclick="closeQuickImage()">‚úï</button>
    <div style="color: white; margin-bottom: 15px; font-weight: 800; font-size: 18px;" id="quick-image-title"></div>
    <div class="quick-image-container" onclick="event.stopPropagation()">
        <iframe id="quick-image-frame" src="" style="width:100%; height:100%; border:none;"></iframe>
    </div>
    <div style="color: rgba(255,255,255,0.6); margin-top: 15px; font-size: 12px;">Kapatmak i√ßin dƒ±≈üarƒ±ya veya ‚úï i≈üaretine dokunun</div>
</div>

<div class="container">
    <div id="offline-status"></div>

    <div id="custom-modal" class="modal-overlay">
        <div class="modal-card">
            <div id="modal-icon" style="font-size: 50px; margin-bottom: 15px;">‚ö†Ô∏è</div>
            <div id="modal-title" style="font-weight: 800; font-size: 22px; margin-bottom: 10px;">Onay</div>
            <div id="modal-text" style="font-size: 15px; color: var(--text-sub); margin-bottom: 25px; line-height: 1.5;">ƒ∞≈ülemi onaylƒ±yor musunuz?</div>
            <div class="modal-buttons" style="display: flex; gap: 12px;">
                <button id="modal-cancel-btn" style="background: var(--bg-gray); color: var(--text-main); flex: 1;" onclick="closeModal()">ƒ∞PTAL</button>
                <button id="modal-confirm-btn" style="flex: 1;">ONAYLA</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay">
        <div style="width: 50px; height: 50px; border: 5px solid var(--border); border-top-color: var(--valeo-green); border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 15px; font-weight: 800; color: var(--valeo-green);">L√úTFEN BEKLEYƒ∞N...</p>
    </div>

    <div id="main-top-bar" class="top-bar" style="display:none;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div id="btn-back" onclick="goBack()" style="display:none; cursor:pointer; font-size:22px;">‚¨ÖÔ∏è</div>
            <div style="font-size: 14px; font-weight: 800; letter-spacing: 1.5px;">VALEO V2 PRO</div>
        </div>
        <div style="cursor:pointer; font-size: 24px;" onclick="toggleMenu(event)">‚ò∞</div>
        <div id="dropdown" class="dropdown-menu">
            <div onclick="toggleDarkMode()">üåì G√∂r√ºn√ºm Deƒüi≈ütir</div>
            <div onclick="gecmisGoster()">üìã ƒ∞≈ülem Ge√ßmi≈üi</div>
            <div onclick="guvenliCikis()" style="color:var(--danger); font-weight:bold;">üö™ G√ºvenli √áƒ±kƒ±≈ü</div>
        </div>
    </div>

    <div id="page-login" class="page active-page">
        <div class="content" style="display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
            <h1 style="color:var(--valeo-green); font-size:60px; margin:0; font-weight:800;">Valeo</h1>
            <p style="letter-spacing:5px; font-size:12px; opacity:0.6; margin-bottom:40px; font-weight:600;">BAKIM DEPO Sƒ∞STEMƒ∞</p>
            <div style="width: 100%; max-width: 320px;">
                <input type="text" id="user-input" placeholder="Kullanƒ±cƒ± Adƒ±">
                <input type="password" id="pass-input" placeholder="≈ûifre">
                <button onclick="girisYap()" style="margin-top: 10px;">Sƒ∞STEME Gƒ∞Rƒ∞≈û YAP</button>
            </div>
        </div>
    </div>

    <div id="page-search" class="page">
        <div class="content">
            <h2 style="margin-top:0; font-weight: 800;">Stok Arama</h2>
            <div style="position:relative; margin-bottom: 25px;">
                <input type="text" id="search-main" placeholder="SAP kodu veya malzeme adƒ± yazƒ±n..." oninput="aramaYap()" style="padding-left:55px; height: 65px; border-radius: 18px; font-size: 17px;">
                <span style="position:absolute; left:20px; top:22px; font-size: 24px; opacity:0.3;">üîç</span>
            </div>
            <div id="search-results"></div>
        </div>
    </div>

    <div id="page-detail" class="page">
        <div class="content">
            <div id="detail-image-panel"><iframe id="detail-frame" src=""></iframe></div>
            <div style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-start; gap: 10px;">
                <div style="flex: 1; min-width: 250px;">
                    <h2 id="detay-ad" style="margin:0; font-size:26px; font-weight: 800;"></h2>
                    <div id="detay-sap" style="color:var(--valeo-green); font-size:20px; font-weight:900; margin-top: 5px;"></div>
                </div>
                <button id="btn-toggle-img" onclick="toggleImage()" style="width: auto; background:var(--valeo-dark); padding: 10px 20px; font-size: 13px;">üñºÔ∏è G√ñRSEL</button>
            </div>
            <hr style="border: 0; border-top: 1px solid var(--border); margin: 25px 0;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div style="background:var(--bg-gray); padding:20px; border-radius:18px; text-align: center;">
                    <label style="display:block; font-size:11px; font-weight:800; opacity:0.5; margin-bottom:5px;">LOKASYON</label>
                    <span id="detay-adres" style="font-weight:700; font-size:18px;"></span>
                </div>
                <div style="background:var(--bg-gray); padding:20px; border-radius:18px; text-align: center;">
                    <label style="display:block; font-size:11px; font-weight:800; opacity:0.5; margin-bottom:5px;">G√úNCEL STOK</label>
                    <span id="detay-stok" style="font-weight:700; font-size:18px;"></span>
                </div>
            </div>
            <button onclick="goToAction()" style="margin-top:30px; background:var(--valeo-blue); height: 70px; font-size: 18px;">BU √úR√úNLE ƒ∞≈ûLEM YAP ‚ûî</button>
        </div>
    </div>

    <div id="page-action" class="page">
        <div class="content">
            <h3 style="margin-top:0; font-weight:800;">Makine ve Miktar</h3>
            <input type="text" id="action-machine-search" placeholder="Makine se√ßin..." oninput="makineAramaYap()">
            <div id="selected-machine-box" style="display:none; background: linear-gradient(135deg, var(--valeo-blue), #00d2ff); color: white; padding: 20px; border-radius: 20px; margin: 15px 0;">
                <div id="selected-machine-text" style="font-weight:800; font-size:18px;"></div>
            </div>
            <div id="machine-results"></div>
            <div class="stepper">
                <button onclick="adetDegistir(-1)">‚àí</button>
                <input type="number" id="islem-adet" value="0" readonly>
                <button onclick="adetDegistir(1)">+</button>
            </div>
            <div style="display: flex; gap: 15px; margin-top: 30px;">
                <button id="btn-dusum" style="background:var(--danger); flex: 1;" onclick="finalOnay('STOKTAN D√ú≈û√úM')" disabled>üìâ D√ú≈û√úM</button>
                <button id="btn-talep" style="background:var(--valeo-dark); flex: 1;" onclick="finalOnay('Sƒ∞PARƒ∞≈û TALEBƒ∞')" disabled>üõí TALEP</button>
            </div>
        </div>
    </div>

    <div id="page-history" class="page">
        <div class="content">
            <h3 style="margin-top:0; font-weight:800;">ƒ∞≈ülem Ge√ßmi≈üi</h3>
            <div style="overflow-x: auto;">
                <table class="history-table"><tbody id="history-body"></tbody></table>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxGCCJo34saMWKeLiFKUaWZzZh3k4sIoAiRYZ_oV7rNPWtf60UaXJUKWIn0g27RRMsIRg/exec';
    const URUN_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBzW/pub?gid=1489941403&single=true&output=csv';
    const USER_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBzW/pub?gid=1584268931&single=true&output=csv';
    const MAKINA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBzW/pub?gid=1658888580&single=true&output=csv';
    const GECMIS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBzW/pub?gid=185766952&single=true&output=csv';

    let urunler = [], makineler = [], kullanicilar = [], seciliUrun = null, seciliMakina = null;

    function girisYap() {
        const u = document.getElementById('user-input').value.trim().toLowerCase();
        const p = document.getElementById('pass-input').value.trim();
        const found = kullanicilar.find(row => (row[0] || row.Kullanƒ±cƒ±)?.toString().toLowerCase() === u && (row[1] || row.≈ûifre)?.toString() === p);
        if (found) { localStorage.setItem('depoUser', u); showPage('page-search'); } else { alert("Hata!"); }
    }

    function trNormalize(text) {
        if (!text) return "";
        return text.toString().toLowerCase('tr').replace(/ƒ±/g, 'i').replace(/ƒ∞/g, 'i').replace(/√∂/g, 'o').replace(/√º/g, 'u').replace(/≈ü/g, 's').replace(/√ß/g, 'c').replace(/ƒü/g, 'g').trim();
    }

    function aramaYap() {
        const query = trNormalize(document.getElementById('search-main').value);
        const results = document.getElementById('search-results');
        if (!query) { results.innerHTML = ""; return; }
        const searchTerms = query.split(/\s+/);
        const filtered = urunler.filter(u => searchTerms.every(t => trNormalize(Object.values(u).join(" ")).includes(t)));
        
        results.innerHTML = filtered.slice(0, 30).map(u => {
            const v = Object.values(u);
            const sap = v[0], ad = v[1], adres = v[2], stok = parseInt(v[3]) || 0;
            let color = stok === 0 ? "var(--danger)" : "var(--valeo-green)";
            
            return `<div class="product-card" onclick="openDetail('${sap}')" style="border-left-color: ${color};">
                <div>
                    <div style="font-weight:900; color:${color}; font-size:12px;">SAP: ${sap}</div>
                    <div style="font-weight:700; font-size:15px; margin-top:5px;">${ad}</div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:15px;">
                    <div style="display:flex; flex-direction:column;">
                         <span style="font-size:12px; color:var(--text-sub);">üìç ${adres}</span>
                         <button class="btn-quick-view" onclick="event.stopPropagation(); openQuickImage('${ad}')">üëÅÔ∏è G√ñRSELE BAK</button>
                    </div>
                    <span style="background:${color}; color:white; padding:4px 10px; border-radius:8px; font-weight:800; font-size:12px;">${stok} ADET</span>
                </div>
            </div>`;
        }).join('');
    }

    // YENƒ∞: HIZLI G√ñRSEL A√áMA FONKSƒ∞YONU
    function openQuickImage(ad) {
        const overlay = document.getElementById('quick-image-overlay');
        const frame = document.getElementById('quick-image-frame');
        const title = document.getElementById('quick-image-title');
        
        title.innerText = ad;
        frame.src = `https://www.bing.com/images/search?q=${encodeURIComponent(ad)}+valeo+spare+part&form=HDRSC2`;
        overlay.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Kaydƒ±rmayƒ± engelle
    }

    function closeQuickImage() {
        document.getElementById('quick-image-overlay').style.display = 'none';
        document.getElementById('quick-image-frame').src = "";
        document.body.style.overflow = 'auto';
    }

    function openDetail(sap) {
        seciliUrun = Object.values(urunler.find(u => Object.values(u)[0].toString() === sap.toString()));
        document.getElementById('detay-ad').innerText = seciliUrun[1];
        document.getElementById('detay-sap').innerText = "SAP: " + seciliUrun[0];
        document.getElementById('detay-adres').innerText = seciliUrun[2];
        document.getElementById('detay-stok').innerText = seciliUrun[3];
        document.getElementById('detail-frame').src = `https://www.bing.com/images/search?q=${encodeURIComponent(seciliUrun[1])}`;
        document.getElementById('detail-image-panel').style.display = "none";
        showPage('page-detail');
    }

    // Standart Fonksiyonlar
    function showPage(pId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        document.getElementById(pId).classList.add('active-page');
        document.getElementById('main-top-bar').style.display = (pId === 'page-login') ? 'none' : 'flex';
        document.getElementById('btn-back').style.display = (pId === 'page-login' || pId === 'page-search') ? 'none' : 'block';
    }
    function goBack() { showPage('page-search'); }
    function toggleImage() { const p = document.getElementById('detail-image-panel'); p.style.display = p.style.display === "none" ? "block" : "none"; }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
    function toggleMenu(e) { e.stopPropagation(); const d = document.getElementById('dropdown'); d.style.display = d.style.display === 'block' ? 'none' : 'block'; }
    function closeMenuOutside() { document.getElementById('dropdown').style.display = 'none'; }
    function guvenliCikis() { localStorage.removeItem('depoUser'); location.reload(); }

    window.onload = async () => {
        if (localStorage.getItem('depoUser')) showPage('page-search');
        try {
            const [uRes, pRes, mRes] = await Promise.all([fetch(USER_URL), fetch(URUN_URL), fetch(MAKINA_URL)]);
            const parse = async (r) => XLSX.utils.sheet_to_json(XLSX.read(await r.text(), {type:'string'}).Sheets.Sheet1);
            kullanicilar = await parse(uRes); urunler = await parse(pRes); makineler = await parse(mRes);
        } catch (e) { console.error("Veri y√ºklenemedi."); }
    };
</script>
</body>
</html>
