<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valeo BakÄ±m PortalÄ± - V2 PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --valeo-green: #99cc00; --valeo-blue: #0091ff; --valeo-dark: #1a1a1b; 
            --bg-gray: #f8f9fa; --card-bg: #ffffff; --text-main: #2d3436; 
            --text-sub: #636e72; --danger: #ff4757; --shadow: 0 10px 25px rgba(0,0,0,0.08); --border: #edf2f7;
        }
        body.dark-mode { 
            --bg-gray: #121212; --card-bg: #1e1e1e; --text-main: #f5f6fa; 
            --valeo-dark: #000000; --border: #2d3436;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg-gray); color: var(--text-main); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: var(--card-bg); width: 100%; max-width: 1400px; height: 92vh; border-radius: 24px; box-shadow: var(--shadow); display: flex; flex-direction: column; overflow: hidden; margin: 10px; border: 1px solid var(--border); }
        .top-bar { background: var(--valeo-dark); color: white; padding: 18px 30px; display: flex; justify-content: space-between; align-items: center; }
        .content { padding: 30px; overflow-y: auto; flex-grow: 1; }
        input { width: 100%; padding: 16px; margin: 10px 0; border-radius: 12px; border: 2px solid var(--border); background: var(--card-bg); color: var(--text-main); font-size: 15px; box-sizing: border-box; }
        button { background: var(--valeo-green); color: white; border: none; padding: 18px; border-radius: 14px; font-weight: 700; cursor: pointer; }
        button:disabled { background: #cbd5e0 !important; opacity: 0.6; }
        #search-results, #machine-results { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-top: 15px; }
        .product-card { background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 15px; border-left: 5px solid var(--valeo-green); cursor: pointer; }
        .page { display: none; height: 100%; flex-direction: column; }
        .active-page { display: flex; }
        .history-table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 20px; }
        .history-table th { background: var(--valeo-dark); color: white; padding: 15px 10px; text-align: left; position: sticky; top: 0; }
        .history-table td { padding: 15px 10px; border-bottom: 1px solid var(--border); }
        .dropdown-menu { display: none; position: absolute; right: 30px; top: 70px; background: var(--card-bg); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 50; min-width: 200px; border: 1px solid var(--border); }
        .dropdown-menu div { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid var(--border); }
        #loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:white; display:flex; justify-content:center; align-items:center; z-index:9999; }
    </style>
</head>
<body onclick="closeMenuOutside(event)">

<div id="loading-overlay">Veriler YÃ¼kleniyor...</div>

<div class="container">
    <div id="main-top-bar" class="top-bar" style="display:none;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <div id="btn-back" onclick="goBack()" style="display:none; cursor:pointer; font-size:24px;">â¬…ï¸</div>
            <div style="font-weight: 800; letter-spacing: 2px;">VALEO PORTAL</div>
        </div>
        <div style="cursor:pointer; font-size: 24px;" onclick="toggleMenu(event)">â˜°</div>
        <div id="dropdown" class="dropdown-menu">
            <div onclick="toggleDarkMode()">ğŸŒ“ KaranlÄ±k Mod</div>
            <div onclick="gecmisGoster()">ğŸ“‹ Ä°ÅŸlem GeÃ§miÅŸi</div>
            <div onclick="guvenliCikis()" style="color:var(--danger)">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</div>
        </div>
    </div>

    <div id="page-login" class="page active-page">
        <div class="content" style="text-align:center; margin-top:10vh;">
            <h1 style="color:var(--valeo-green); font-size:64px; margin:0;">Valeo</h1>
            <div style="max-width: 400px; margin: 0 auto;">
                <input type="text" id="user-input" placeholder="KullanÄ±cÄ± AdÄ±">
                <input type="password" id="pass-input" placeholder="Åifre">
                <button onclick="girisYap()" style="width:100%">GÄ°RÄ°Å YAP</button>
            </div>
        </div>
    </div>

    <div id="page-search" class="page">
        <div class="content">
            <h2>Stok Arama</h2>
            <input type="text" id="search-main" placeholder="SAP veya Malzeme AdÄ±..." oninput="aramaYap()">
            <div id="search-results"></div>
        </div>
    </div>

    <div id="page-detail" class="page">
        <div class="content">
            <h2 id="detay-ad"></h2>
            <p id="detay-sap" style="color:var(--valeo-green); font-weight:bold; font-size:20px;"></p>
            <div style="background:var(--bg-gray); padding:20px; border-radius:15px;">
                <p>ğŸ“ Adres: <span id="detay-adres"></span></p>
                <p>ğŸ“¦ Stok: <b id="detay-stok"></b> ADET</p>
            </div>
            <button onclick="goToAction()" style="width:100%; margin-top:20px; background:var(--valeo-blue)">BU ÃœRÃœNÃœ SEÃ‡</button>
        </div>
    </div>

    <div id="page-action" class="page">
        <div class="content">
            <h3>Ä°ÅŸlem KaydÄ±</h3>
            <input type="text" id="action-machine-search" placeholder="Makina No Ara..." oninput="makineAramaYap()">
            <div id="machine-results"></div>
            <div id="selected-machine-box" style="display:none; padding:15px; background:var(--valeo-blue); color:white; border-radius:10px; margin:10px 0; text-align:center;"></div>
            
            <div style="text-align:center; margin:30px 0;">
                <button onclick="adetDegistir(-1)" style="width:50px">-</button>
                <input type="number" id="islem-adet" value="0" style="width:100px; text-align:center; font-size:24px; border:none;" readonly>
                <button onclick="adetDegistir(1)" style="width:50px">+</button>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <button id="btn-dusum" onclick="finalOnay('STOKTAN DÃœÅÃœM')" disabled style="background:var(--danger)">ğŸ“‰ DÃœÅÃœM</button>
                <button id="btn-talep" onclick="finalOnay('SÄ°PARÄ°Å TALEBÄ°')" disabled style="background:var(--valeo-dark)">ğŸ›’ TALEP</button>
            </div>
        </div>
    </div>

    <div id="page-history" class="page">
        <div class="content">
            <h2>Ä°ÅŸlem GeÃ§miÅŸi</h2>
            <div style="overflow-x:auto;">
                <table class="history-table">
                    <thead>
                        <tr><th>Tarih & Saat</th><th>SAP</th><th>Malzeme</th><th>Adet</th><th>Ä°ÅŸlem</th><th>Makina</th><th>KullanÄ±cÄ±</th><th>Yetkili</th></tr>
                    </thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxGCCJo34saMWKeLiFKUaWZzZh3k4sIoAiRYZ_oV7rNPWtf60UaXJUKWIn0g27RRMsIRg/exec';
    const BASE_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBzW/pub?output=csv&gid=';
    const GIDS = { URUN: '1489941403', USER: '1584268931', MAKINA: '1658888580', GECMIS: '185766952' };

    let urunler = [], makineler = [], kullanicilar = [], seciliUrun = null, seciliMakina = null;

    // GÃœN.AY.YIL SAAT:DAKÄ°KA FORMATI
    function getFormattedDate(date) {
        const d = date ? new Date(date) : new Date();
        return d.toLocaleString('tr-TR', {
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit'
        }).replace(',', '');
    }

    // Excel sayÄ±sal tarihini (46174...) GG.AA.YYYY SS:DD formatÄ±na Ã§evirir
    function formatExcelDate(serial) {
        if (!serial || isNaN(serial)) return serial || "-";
        const dateObj = XLSX.SSF.parse_date_code(serial);
        const d = new Date(dateObj.y, dateObj.m - 1, dateObj.d, dateObj.H, dateObj.M);
        return getFormattedDate(d);
    }

    async function fetchData() {
        try {
            const [u, p, m] = await Promise.all([
                fetch(BASE_URL + GIDS.USER).then(r => r.text()),
                fetch(BASE_URL + GIDS.URUN).then(r => r.text()),
                fetch(BASE_URL + GIDS.MAKINA).then(r => r.text())
            ]);
            const parse = (d) => XLSX.utils.sheet_to_json(XLSX.read(d, {type:'string'}).Sheets.Sheet1, {header: 1});
            kullanicilar = parse(u).slice(1);
            urunler = parse(p).slice(1);
            makineler = parse(m).slice(1);
            document.getElementById('loading-overlay').style.display = 'none';
        } catch (e) { alert("Veri yÃ¼kleme hatasÄ±!"); }
    }

    async function gecmisGoster() {
        showPage('page-history');
        const res = await fetch(BASE_URL + GIDS.GECMIS);
        const data = XLSX.utils.sheet_to_json(XLSX.read(await res.text(), {type:'string'}).Sheets.Sheet1, {header: 1});
        const rows = data.slice(1).reverse().slice(0, 40);
        document.getElementById('history-body').innerHTML = rows.map(row => `
            <tr>
                <td>${formatExcelDate(row[6])}</td>
                <td><b>${row[0]}</b></td>
                <td>${row[1]}</td>
                <td>${row[3]}</td>
                <td>${row[4]}</td>
                <td>${row[5]}</td>
                <td>${row[2]}</td>
                <td>${row[7] || '-'}</td>
            </tr>`).join('');
    }

    async function kaydet(islem, adet) {
        const user = kullanicilar.find(r => r[0]?.toString().toLowerCase() === localStorage.getItem('depoUser'));
        const veri = { 
            tarih: getFormattedDate(), // Yeni kayÄ±t anÄ±ndaki tarih ve saat
            sap: seciliUrun[0], ad: seciliUrun[1], 
            kullanici: user ? user[5] : localStorage.getItem('depoUser'),
            adet: adet, islem: islem, makina: seciliMakina.no, 
            yetkili: user ? user[7] : "-" 
        };
        fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(veri) });
        alert("KAYDEDÄ°LDÄ°"); showPage('page-search');
    }

    // Navigasyon ve Arama FonksiyonlarÄ±
    function aramaYap() {
        const q = document.getElementById('search-main').value.toLowerCase();
        const res = urunler.filter(u => u[0].toString().includes(q) || u[1].toLowerCase().includes(q));
        document.getElementById('search-results').innerHTML = res.slice(0, 20).map(u => `
            <div class="product-card" onclick="openDetail('${u[0]}')"><b>SAP: ${u[0]}</b><br>${u[1]}</div>`).join('');
    }
    function openDetail(sap) {
        seciliUrun = urunler.find(u => u[0].toString() === sap.toString());
        document.getElementById('detay-ad').innerText = seciliUrun[1];
        document.getElementById('detay-sap').innerText = "SAP: " + seciliUrun[0];
        document.getElementById('detay-adres').innerText = seciliUrun[2];
        document.getElementById('detay-stok').innerText = seciliUrun[3];
        showPage('page-detail');
    }
    function makineAramaYap() {
        const q = document.getElementById('action-machine-search').value.toLowerCase();
        const res = makineler.filter(m => m[0].toString().includes(q) || m[1].toLowerCase().includes(q));
        document.getElementById('machine-results').innerHTML = res.slice(0, 5).map(m => `
            <div class="product-card" onclick="selectMachine('${m[0]}')"><b>${m[0]}</b> - ${m[1]}</div>`).join('');
    }
    function selectMachine(no) {
        seciliMakina = { no };
        document.getElementById('selected-machine-box').innerText = "SEÃ‡Ä°LDÄ°: " + no;
        document.getElementById('selected-machine-box').style.display = 'block';
        updateBtn();
    }
    function adetDegistir(d) { 
        let v = parseInt(document.getElementById('islem-adet').value) + d; 
        if(v >= 0) document.getElementById('islem-adet').value = v; 
        updateBtn(); 
    }
    function updateBtn() { document.getElementById('btn-dusum').disabled = !(seciliMakina && parseInt(document.getElementById('islem-adet').value) > 0); }
    function girisYap() {
        const u = document.getElementById('user-input').value.toLowerCase();
        const p = document.getElementById('pass-input').value;
        if (kullanicilar.find(r => r[0]?.toString().toLowerCase() === u && r[1]?.toString() === p)) {
            localStorage.setItem('depoUser', u); showPage('page-search');
        } else alert("HatalÄ± GiriÅŸ!");
    }
    function showPage(p) { 
        document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active-page'));
        document.getElementById(p).classList.add('active-page');
        document.getElementById('main-top-bar').style.display = p === 'page-login' ? 'none' : 'flex';
        document.getElementById('btn-back').style.display = (p === 'page-login' || p === 'page-search') ? 'none' : 'block';
    }
    function toggleMenu(e) { e.stopPropagation(); document.getElementById('dropdown').style.display = 'block'; }
    function closeMenuOutside() { document.getElementById('dropdown').style.display = 'none'; }
    function goBack() { showPage('page-search'); }
    function goToAction() { showPage('page-action'); }
    function guvenliCikis() { localStorage.clear(); location.reload(); }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
    function finalOnay(i) { if(confirm(i + " onaylÄ±yor musunuz?")) kaydet(i, document.getElementById('islem-adet').value); }

    window.onload = () => { fetchData(); if (localStorage.getItem('depoUser')) showPage('page-search'); };
</script>
</body>
</html>
