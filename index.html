<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valeo BakÄ±m PortalÄ± - V2 PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --valeo-green: #99cc00; 
            --valeo-blue: #0091ff; 
            --valeo-dark: #1a1a1b; 
            --bg-gray: #f8f9fa; 
            --card-bg: #ffffff; 
            --text-main: #2d3436; 
            --text-sub: #636e72; 
            --danger: #ff4757; 
            --warning: #f1c40f;
            --shadow: 0 10px 25px rgba(0,0,0,0.08); 
            --border: #edf2f7;
        }
        
        body.dark-mode { 
            --bg-gray: #121212; 
            --card-bg: #1e1e1e; 
            --text-main: #f5f6fa; 
            --text-sub: #b2bec3; 
            --valeo-dark: #000000; 
            --border: #2d3436;
            --shadow: 0 10px 25px rgba(0,0,0,0.4);
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-gray); color: var(--text-main); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; transition: 0.3s; padding: 10px; box-sizing: border-box; }
        
        .container { 
            background: var(--card-bg); 
            width: 100%; 
            max-width: 500px; 
            height: 95vh; 
            max-height: 900px; 
            border-radius: 24px; 
            box-shadow: var(--shadow); 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            position: relative; 
            border: 1px solid var(--border); 
        }

        #offline-status { text-align: center; padding: 8px; font-size: 11px; font-weight: 800; display: none; z-index: 100; }
        @media (min-width: 768px) { .container { max-width: 600px; height: 85vh; } }

        .modal-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000; justify-content: center; align-items: center; }
        .modal-card { background: var(--card-bg); width: 85%; max-width: 350px; border-radius: 24px; padding: 30px; text-align: center; box-shadow: var(--shadow); animation: modalSlideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes modalSlideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-icon { font-size: 45px; margin-bottom: 15px; }
        .modal-title { font-weight: 800; font-size: 20px; margin-bottom: 10px; color: var(--text-main); }
        .modal-text { font-size: 14px; color: var(--text-sub); margin-bottom: 25px; line-height: 1.5; }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 15px; border-radius: 14px; font-weight: 700; cursor: pointer; border: none; transition: 0.2s; font-size: 13px; }
        .btn-confirm { background: var(--valeo-green); color: white; }
        .btn-cancel { background: var(--bg-gray); color: var(--text-main); }

        #loading-overlay { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.85); z-index: 1000; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        body.dark-mode #loading-overlay { background: rgba(0, 0, 0, 0.85); }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top: 4px solid var(--valeo-green); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .top-bar { background: var(--valeo-dark); color: white; padding: 18px; display: flex; justify-content: space-between; align-items: center; z-index: 10; flex-shrink: 0; }
        .content { padding: 20px; overflow-y: auto; flex-grow: 1; position: relative; }
        
        input { width: 100%; padding: 16px; margin: 10px 0; border-radius: 12px; border: 2px solid var(--border); background: var(--card-bg); color: var(--text-main); font-size: 15px; box-sizing: border-box; transition: 0.2s; }
        input:focus { border-color: var(--valeo-green); outline: none; }
        
        button { background: var(--valeo-green); color: white; border: none; padding: 18px; border-radius: 14px; font-weight: 700; cursor: pointer; width: 100%; transition: 0.2s; }
        button:disabled { background: #cbd5e0 !important; opacity: 0.6; cursor: not-allowed; }
        
        .product-card { background: var(--card-bg); border: 1px solid var(--border); margin-bottom: 12px; padding: 15px; border-radius: 15px; border-left: 5px solid var(--valeo-green); cursor: pointer; transition: 0.2s; }
        .product-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        
        .page { display: none; height: 100%; flex-direction: column; animation: fadeIn 0.3s; }
        .active-page { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* VURGULAMA STÄ°LÄ° */
        mark { background: #99cc00; color: #000; padding: 0 1px; border-radius: 2px; font-weight: bold; }

        #detail-image-panel { width: 100%; height: 200px; border-radius: 15px; overflow: hidden; margin-bottom: 15px; border: 1px solid var(--border); display: none; }
        #detail-frame { width: 100%; height: 100%; border: none; }
        
        .stepper { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 20px 0; background: var(--bg-gray); padding: 10px; border-radius: 15px; }
        .stepper button { width: 50px; height: 50px; border-radius: 50%; background: var(--valeo-dark); font-size: 20px; padding: 0; color: white; }
        #islem-adet { width: 70px; text-align: center; font-size: 24px; font-weight: 800; border: none; background: transparent; color: var(--text-main); }
        
        .dropdown-menu { display: none; position: absolute; right: 15px; top: 60px; background: var(--card-bg); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 50; min-width: 170px; overflow: hidden; border: 1px solid var(--border); }
        .dropdown-menu div { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 14px; color: var(--text-main); }
        
        .history-table { width: 100%; border-collapse: collapse; font-size: 10px; }
        .history-table th { background: var(--valeo-dark); color: white; padding: 12px 5px; text-align: left; position: sticky; top: 0; }
        .history-table td { padding: 12px 5px; border-bottom: 1px solid var(--border); color: var(--text-main); font-weight: 500; }
    </style>
</head>
<body onclick="closeMenuOutside(event)">

<div class="container">
    <div id="offline-status"></div>

    <div id="custom-modal" class="modal-overlay">
        <div class="modal-card">
            <div id="modal-icon" class="modal-icon">âš ï¸</div>
            <div id="modal-title" class="modal-title">Emin misiniz?</div>
            <div id="modal-text" class="modal-text">Bu iÅŸlemi onaylÄ±yor musunuz?</div>
            <div class="modal-buttons">
                <button id="modal-cancel-btn" class="modal-btn btn-cancel" onclick="closeModal()">Ä°PTAL</button>
                <button id="modal-confirm-btn" class="modal-btn btn-confirm">ONAYLA</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="font-weight: 800; color: var(--valeo-green);">YÃœKLENÄ°YOR...</div>
    </div>

    <div id="page-login" class="page active-page">
        <div class="content" style="display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;">
            <div style="margin-bottom:40px;">
                <h1 style="color:var(--valeo-green); font-size:50px; margin:0; font-weight:800;">Valeo</h1>
                <p style="letter-spacing:4px; font-size:10px; opacity:0.6; font-weight:800; margin-top:-5px;">V2 PRO PORTAL</p>
            </div>
            <input type="text" id="user-input" placeholder="KullanÄ±cÄ± AdÄ±" style="margin-bottom:15px;">
            <input type="password" id="pass-input" placeholder="Åifre" style="margin-bottom:25px;">
            <button onclick="girisYap()" style="height:65px; font-size:16px;">SÄ°STEME GÄ°RÄ°Å YAP</button>
        </div>
    </div>

    <div id="main-top-bar" class="top-bar" style="display:none;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div id="btn-back" onclick="goBack()" style="display:none; cursor:pointer; font-size:18px;">â¬…ï¸</div>
            <div style="font-size: 12px; font-weight: 800; letter-spacing: 1px;">VALEO PORTAL</div>
        </div>
        <div style="cursor:pointer; font-size: 20px;" onclick="toggleMenu(event)">â˜°</div>
        <div id="dropdown" class="dropdown-menu">
    <div id="admin-menu-item" onclick="showPage('page-admin')" style="display:none; background:var(--valeo-blue); color:white; font-weight:800;">âš™ï¸ YÃ¶netici Paneli</div>
    
    <div onclick="toggleDarkMode()">ğŸŒ“ GÃ¶rÃ¼nÃ¼m DeÄŸiÅŸtir</div>
    <div onclick="gecmisGoster()">ğŸ“‹ Ä°ÅŸlem GeÃ§miÅŸi</div>
    <div onclick="guvenliCikis()" style="color:var(--danger)">ğŸšª GÃ¼venli Ã‡Ä±kÄ±ÅŸ</div>
</div>
    </div>

    <div id="page-search" class="page">
        <div class="content">
            <h3 style="margin-top:0; font-weight: 800;">Stok Arama</h3>
            <div style="position:relative; margin-bottom: 20px;">
                <input type="text" id="search-main" placeholder="Malzeme adÄ± veya SAP no..." oninput="aramaYap()" style="padding-left:45px; height: 60px; border-radius: 16px;">
                <span style="position:absolute; left:15px; top:20px; font-size: 20px; opacity:0.5;">ğŸ”</span>
            </div>
            <div id="search-results" style="display: flex; flex-direction: column; gap: 10px;"></div>
        </div>
    </div>

    <div id="page-detail" class="page">
        <div class="content">
            <div id="detail-image-panel"><iframe id="detail-frame" src=""></iframe></div>
            <button id="btn-toggle-img" onclick="toggleImage()" style="background:var(--valeo-dark); margin-bottom:15px; padding:10px; font-size:12px; height: auto; width: auto;">ğŸ–¼ï¸ GÃ–RSEL</button>
            <h2 id="detay-ad" style="margin:5px 0;"></h2>
            <div id="detay-sap" style="font-weight:900; color:var(--valeo-green); font-size:18px; margin-bottom:15px;"></div>
            <div style="background:var(--bg-gray); padding:15px; border-radius:12px;">
                <div>ğŸ“ Adres: <span id="detay-adres" style="font-weight:700;"></span></div>
                <div style="margin-top:5px;">ğŸ“¦ Stok: <span id="detay-stok" style="font-weight:700;"></span> ADET</div>
            </div>
            <button onclick="goToAction()" style="margin-top:25px; background:var(--valeo-blue);">BU ÃœRÃœNLE Ä°ÅLEM YAP</button>
        </div>
    </div>

    <div id="page-action" class="page">
        <div class="content">
            <input type="text" id="action-machine-search" placeholder="Makine ara..." oninput="makineAramaYap()">
            <div id="selected-machine-box" style="display:none; background:var(--valeo-blue); color:white; padding:15px; border-radius:12px; margin:10px 0;">
                <div id="selected-machine-text" style="font-weight:800;"></div>
            </div>
            <div id="machine-results"></div>
            <div class="stepper">
                <button onclick="adetDegistir(-1)">-</button>
                <input type="number" id="islem-adet" value="0" readonly>
                <button onclick="adetDegistir(1)">+</button>
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="btn-dusum" style="background:var(--danger); flex: 1;" onclick="finalOnay('STOKTAN DÃœÅÃœM')" disabled>ğŸ“‰ DÃœÅÃœM</button>
                <button id="btn-talep" style="background:var(--valeo-dark); flex: 1;" onclick="finalOnay('SÄ°PARÄ°Å TALEBÄ°')" disabled>ğŸ›’ TALEP</button>
            </div>
        </div>
    </div>

    <div id="page-history" class="page">
        <div class="content">
            <h3>Ä°ÅŸlem GeÃ§miÅŸi</h3>
            <div style="overflow-x: auto;">
                <table class="history-table">
                    <thead><tr><th>SAP</th><th>KULLANICI</th><th>Ä°ÅLEM TÄ°PÄ°</th><th>SAP KODU</th><th>MALZEME ADI</th><th>ADET</th><th>MAKÄ°NA NO</th><th>MAKÄ°NA ADI</th><th>GÃ–REVLÄ°</th></tr></thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<div id="page-admin" class="page">
    <div class="content">
        <h3 style="font-weight:800; border-bottom:3px solid var(--valeo-blue); padding-bottom:10px;">ğŸ‘¤ KullanÄ±cÄ± YÃ¶netimi</h3>
        
        <div style="background:var(--bg-gray); padding:15px; border-radius:15px; margin-bottom:20px; border:1px solid var(--border);">
            <h4 style="margin-top:0;">â• Yeni KullanÄ±cÄ±</h4>
            <input type="text" id="new-user-name" placeholder="Ad Soyad">
            <input type="text" id="new-user-pass" placeholder="Åifre">
            <select id="new-user-role" style="width:100%; padding:12px; border-radius:10px; border:2px solid var(--border); margin:5px 0;">
                <option value="KullanÄ±cÄ±">KullanÄ±cÄ±</option>
                <option value="YÃ¶netici">YÃ¶netici</option>
            </select>
            <button onclick="kullaniciEkle()" style="background:var(--valeo-blue); margin-top:10px;">LÄ°STEYE EKLE</button>
        </div>

        <h4>ğŸ‘¥ Mevcut Liste</h4>
        <div id="admin-user-list"></div>
    </div>
</div>


<script>
    const USER_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBzW/pub?gid=1584268931&single=true&output=csv';
    const URUN_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBzW/pub?gid=1489941403&single=true&output=csv';
    const MAKINA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBzW/pub?gid=1658888580&single=true&output=csv';
    const GECMIS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBzW/pub?gid=185766952&single=true&output=csv';
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz9qV37Xa4ESuHQGtOa3UW21Y4WAyLMAwAgGnnY1oFnUkpIpKsvi1vSFmFyRAjkwcIjhQ/exec';

    let urunler = [], kullanicilar = [], makineler = [], seciliUrun = null;
    let seciliMakina = null; // BU SATIR EKSÄ°K OLDUÄU Ä°Ã‡Ä°N Ã‡ALIÅMIYORDU

    function trNormalize(text) {
        if (!text) return "";
        return text.toString().toLowerCase('tr')
            .replace(/Ä±/g, 'i').replace(/Ä°/g, 'i')
            .replace(/Ã¶/g, 'o').replace(/Ã¼/g, 'u')
            .replace(/ÅŸ/g, 's').replace(/Ã§/g, 'c')
            .replace(/ÄŸ/g, 'g').trim();
    }

    async function sifreGuncelle(kullaniciAdi) {
    const yeniSifre = prompt(kullaniciAdi + " iÃ§in yeni ÅŸifreyi girin:");
    if (!yeniSifre) return;

    const veri = {
        islem: "SIFRE_GUNCELLE",
        ad: kullaniciAdi,
        yeniSifre: yeniSifre
    };

    document.getElementById('loading-overlay').style.display = 'flex';

    try {
        await fetch(SCRIPT_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify(veri) 
        });
        alert("Åifre baÅŸarÄ±yla gÃ¼ncellendi! Listenin yenilenmesi zaman alabilir.");
        location.reload();
    } catch (e) {
        alert("Hata oluÅŸtu!");
        document.getElementById('loading-overlay').style.display = 'none';
    }
}

   async function girisYap() {
    const uInput = document.getElementById('user-input').value.trim().toLowerCase();
    const pInput = document.getElementById('pass-input').value.trim();

    const found = kullanicilar.find(row => {
        const v = Object.values(row);
        // v[0]: KullanÄ±cÄ±, v[1]: Åifre, v[2]: Rol (C SÃ¼tunu)
        return v[0]?.toString().toLowerCase() === uInput && v[1]?.toString() === pInput;
    });

    if (found) {
        const v = Object.values(found);
        localStorage.setItem('depoUser', v[0]);
        localStorage.setItem('userRole', v[2] || 'KullanÄ±cÄ±'); // C sÃ¼tunundaki rolÃ¼ kaydeder
        
        uygulaYetki(); // Yetkileri kontrol et
        showPage('page-search');
    } else {
        alert("GiriÅŸ bilgileri hatalÄ±!");
    }
}
function adminPaneliHazirla() {
    const listDiv = document.getElementById('admin-user-list');
    
    // GÃ¼venlik: Liste var mÄ± kontrolÃ¼
    if (!listDiv) return;

    // EÄŸer kullanÄ±cÄ± listesi boÅŸsa veya tanÄ±mlÄ± deÄŸilse
    if (!kullanicilar || kullanicilar.length === 0) {
        listDiv.innerHTML = `
            <div style="text-align:center; padding:20px; color:var(--text-sub);">
                <i class="fas fa-users-slash" style="font-size:24px; margin-bottom:10px; display:block;"></i>
                <p style="font-size:12px;">HenÃ¼z kayÄ±tlÄ± kullanÄ±cÄ± bulunamadÄ±.</p>
            </div>`;
        return;
    }

    // Listeyi oluÅŸtur
    listDiv.innerHTML = kullanicilar.map(user => {
        // Obje anahtarlarÄ±nÄ± doÄŸrudan isimle Ã§aÄŸÄ±rmak (destructuring) daha gÃ¼venlidir
        // VarsayalÄ±m ki yapÄ±: { ad: "...", sifre: "...", yetki: "..." }
        const { ad, sifre, yetki } = user; 

        return `
            <div style="background:var(--card-bg); padding:15px; border-radius:15px; margin-bottom:12px; border:1px solid var(--border); transition: transform 0.2s ease;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="flex-grow: 1;">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                            <strong style="color:var(--valeo-blue); font-size:15px;">${ad}</strong>
                            <span style="font-size:10px; padding:2px 8px; border-radius:10px; background:rgba(0,112,185,0.1); color:var(--valeo-blue); font-weight:600;">
                                ${yetki}
                            </span>
                        </div>
                        <div style="color:var(--text-sub); font-size:12px;">
                            <i class="fas fa-lock" style="font-size:10px; margin-right:4px;"></i>
                            <b>Åifre:</b> <span style="font-family: monospace;">${sifre}</span>
                        </div>
                    </div>
                    <button onclick="sifreGuncelle('${ad}')" 
                            class="admin-btn-warning"
                            style="padding:10px 15px; font-size:11px; background:var(--warning); color:black; border-radius:10px; font-weight:700; border:none; cursor:pointer; display:flex; align-items:center; gap:5px;">
                        <span>ğŸ”‘</span> DeÄŸiÅŸtir
                    </button>
                </div>
            </div>`;
    }).join('');
}

// showPage fonksiyonunun iÃ§ine ÅŸu satÄ±rÄ± ekle ki sayfa aÃ§Ä±lÄ±nca liste dolsun
// if(id === 'page-admin') adminPaneliHazirla();

async function kullaniciEkle() {
    const ad = document.getElementById('new-user-name').value.trim();
    const sifre = document.getElementById('new-user-pass').value.trim();
    const rol = document.getElementById('new-user-role').value;

    if (!ad || !sifre) { 
        alert("LÃ¼tfen isim ve ÅŸifre alanlarÄ±nÄ± doldurun!"); 
        return; 
    }

    // YAZMA Ã–ZELLÄ°ÄÄ°NÄ° BURADA TETÄ°KLÄ°YORUZ
    const veri = { 
        islem: "KULLANICI_EKLE", // Bu baÅŸlÄ±k Google Script tarafÄ±nda Sayfa2'ye yÃ¶nlendirir
        ad: ad, 
        sifre: sifre, 
        rol: rol, 
        kullanici: localStorage.getItem('depoUser'), 
        timestamp: new Date().toLocaleString('tr-TR') 
    };

    document.getElementById('loading-overlay').style.display = 'flex';

    try {
        // Senin SCRIPT_URL linkini kullanarak gÃ¶nderim yapÄ±yoruz
        await fetch(SCRIPT_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify(veri) 
        });
        alert("KullanÄ±cÄ± baÅŸarÄ±yla kaydedildi! Sayfa yenileniyor...");
        location.reload();
    } catch (e) { 
        alert("BaÄŸlantÄ± HatasÄ±! Veri yazÄ±lamadÄ±."); 
        document.getElementById('loading-overlay').style.display = 'none';
    }
}

    function doPost(e) {
  var data = JSON.parse(e.postData.contents);
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheetUser = ss.getSheetByName("Sayfa2");

  // ÅÄ°FRE GÃœNCELLEME Ä°ÅLEMÄ°
  if (data.islem === "SIFRE_GUNCELLE") {
    var dataRange = sheetUser.getDataRange().getValues();
    for (var i = 0; i < dataRange.length; i++) {
      // KullanÄ±cÄ± adÄ±nÄ± bul (A sÃ¼tunu)
      if (dataRange[i][0].toString().toLowerCase() === data.ad.toLowerCase()) {
        sheetUser.getRange(i + 1, 2).setValue(data.yeniSifre); // B sÃ¼tununa (2) yeni ÅŸifreyi yaz
        return ContentService.createTextOutput("Åifre GÃ¼ncellendi");
      }
    }
  }

function uygulaYetki() {
    const role = localStorage.getItem('userRole');
    const adminBtn = document.getElementById('admin-menu-item');
    
    // EÄŸer Excel'de C sÃ¼tununda "YÃ¶netici" yazÄ±yorsa butonu gÃ¶ster
    if (role === 'YÃ¶netici') {
        adminBtn.style.display = 'block';
    } else {
        adminBtn.style.display = 'none';
    }
}
function trNormalize(text) {
    if (!text) return "";
    return text.toString()
        .toLocaleLowerCase('tr-TR') // TÃ¼rkÃ§e yerel kÃ¼Ã§Ã¼k harf
        .replace(/iÌ‡/g, "i")         // KarmaÅŸÄ±k i karakterlerini dÃ¼zelt
        .replace(/Ä±/g, 'i')
        .replace(/Ã¶/g, 'o')
        .replace(/Ã¼/g, 'u')
        .replace(/ÅŸ/g, 's')
        .replace(/Ã§/g, 'c')
        .replace(/ÄŸ/g, 'g')
        .trim();
}

    

    function highlightText(text, queries) {
        if (!queries.length) return text;
        let highlighted = text;
        queries.forEach(query => {
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            highlighted = highlighted.replace(regex, '<mark>$1</mark>');
        });
        return highlighted;
    }

    function aramaYap() {
    const rawInput = document.getElementById('search-main').value;
    const resultsContainer = document.getElementById('search-results');
    
    if (!rawInput.trim()) { resultsContainer.innerHTML = ""; return; }

    const queryNormalized = trNormalize(rawInput);
    // Arama terimlerini boÅŸluklara gÃ¶re parÃ§alara ayÄ±r (Ã¶rn: ["rulman", "6204"])
    const searchTerms = queryNormalized.split(/\s+/).filter(t => t.length > 0);
    
    const filtered = urunler.filter(u => {
        const v = Object.values(u);
        const sapNo = v[0] ? v[0].toString().trim() : "";
        const urunAdi = v[1] ? v[1].toString().trim() : "";
        
        if (!sapNo || !urunAdi || sapNo.toLowerCase() === "sap") return false;

        // TÃ¼m satÄ±r iÃ§eriÄŸini tek bir normalize edilmiÅŸ string yap
        const rowContent = trNormalize(v.join(" "));
        
        // Her bir arama terimi bu satÄ±r iÃ§eriÄŸinde var mÄ± diye bak (AND mantÄ±ÄŸÄ±)
        return searchTerms.every(term => rowContent.includes(term));
    });
    
    resultsContainer.innerHTML = filtered.slice(0, 30).map(u => {
        const v = Object.values(u);
        const sap = v[0].toString();
        const ad = v[1].toString();
        const adres = v[2] ? v[2].toString() : "-";
        const stok = parseInt(v[3]) || 0;

        let statusColor = "var(--valeo-green)";
        if (stok === 0) statusColor = "var(--danger)";
        else if (stok <= 2) statusColor = "var(--warning)";

        return `
            <div class="product-card" onclick="openDetail('${sap}')" style="border-left: 6px solid ${statusColor};">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <div style="font-weight:900; color:${statusColor}; font-size:12px;">SAP: ${highlightText(sap, searchTerms)}</div>
                    <div style="background:${statusColor}; color:white; padding:2px 8px; border-radius:8px; font-size:10px; font-weight:800;">${stok} ADET</div>
                </div>
                <div style="font-weight:700; font-size:15px; margin:8px 0;">${highlightText(ad, searchTerms)}</div>
                <div style="font-size:12px; opacity:0.7;">ğŸ“ Konum: <b>${adres}</b></div>
            </div>`;
    }).join('');
}
    function makineAramaYap() {
    const rawInput = document.getElementById('action-machine-search').value;
    const results = document.getElementById('machine-results');
    
    if(!rawInput.trim()) { results.innerHTML = ""; return; }
    
    const queryNormalized = trNormalize(rawInput);
    const searchTerms = queryNormalized.split(/\s+/).filter(t => t.length > 0);

    const filtered = makineler.filter(m => {
        const rowContent = trNormalize(Object.values(m).join(" "));
        return searchTerms.every(term => rowContent.includes(term));
    });

    results.innerHTML = filtered.slice(0, 5).map(m => {
        const v = Object.values(m);
        return `<div class="product-card" onclick="selectMachine('${v[0]}','${v[1]}')">${v[0]} - ${v[1]}</div>`;
    }).join('');
}

    function openDetail(sap) {
        const found = urunler.find(u => Object.values(u)[0].toString() === sap.toString());
        seciliUrun = Object.values(found);
        document.getElementById('detay-ad').innerText = seciliUrun[1];
        document.getElementById('detay-sap').innerText = "SAP: " + seciliUrun[0];
        document.getElementById('detay-adres').innerText = seciliUrun[2];
        document.getElementById('detay-stok').innerText = seciliUrun[3];
        document.getElementById('detail-image-panel').style.display = "none";
        document.getElementById('detail-frame').src = `https://www.bing.com/images/search?q=${encodeURIComponent(seciliUrun[1])}`;
        showPage('page-detail');
    }

    function makineAramaYap() {
        const query = trNormalize(document.getElementById('action-machine-search').value);
        const results = document.getElementById('machine-results');
        if(!query) { results.innerHTML = ""; return; }
        const filtered = makineler.filter(m => trNormalize(Object.values(m).join(" ")).includes(query));
        results.innerHTML = filtered.slice(0, 5).map(m => {
            const v = Object.values(m);
            return `<div class="product-card" onclick="selectMachine('${v[0]}','${v[1]}')">${v[0]} - ${v[1]}</div>`;
        }).join('');
    }

    function selectMachine(no, ad) {
        seciliMakina = { no, ad };
        document.getElementById('selected-machine-text').innerText = no + " - " + ad;
        document.getElementById('selected-machine-box').style.display = 'block';
        document.getElementById('machine-results').innerHTML = "";
        updateButtons();
    }
    function selectMachine(no, ad) {
    seciliMakina = { no: no.toString(), ad: ad.toString() }; // HafÄ±zaya kaydet
    document.getElementById('selected-machine-text').innerText = no + " - " + ad;
    document.getElementById('selected-machine-box').style.display = 'block';
    document.getElementById('machine-results').innerHTML = "";
    updateButtons();
}

    function goToAction() {
        seciliMakina = null;
        document.getElementById('islem-adet').value = 0;
        document.getElementById('selected-machine-box').style.display = 'none';
        updateButtons();
        showPage('page-action');
    }

    function adetDegistir(d) {
        let v = parseInt(document.getElementById('islem-adet').value) + d;
        document.getElementById('islem-adet').value = v < 0 ? 0 : v;
        updateButtons();
    }

    function updateButtons() {
        const hasAdet = parseInt(document.getElementById('islem-adet').value) > 0;
        document.getElementById('btn-dusum').disabled = !(seciliMakina && hasAdet);
        document.getElementById('btn-talep').disabled = !(seciliMakina && hasAdet);
    }

    function finalOnay(islem) {
        const adet = document.getElementById('islem-adet').value;
        document.getElementById('modal-icon').innerText = islem === 'STOKTAN DÃœÅÃœM' ? 'ğŸ“‰' : 'ğŸ›’';
        document.getElementById('modal-title').innerText = islem;
        document.getElementById('modal-text').innerHTML = `<b>${seciliUrun[1]}</b> iÃ§in <b>${adet} adet</b> onaylÄ±yor musunuz?`;
        document.getElementById('modal-confirm-btn').onclick = function() { closeModal(); kaydet(islem, adet); };
        document.getElementById('custom-modal').style.display = 'flex';
    }

   async function kaydet(islem, adet) {
    if (!seciliMakina) { 
        alert("LÃ¼tfen bir makine seÃ§in!"); 
        return; 
    }

    const veri = { 
        sap: String(seciliUrun[0]).split(" ")[0], // SAP'deki tarihleri temizler
        ad: seciliUrun[1], 
        adet: adet, 
        islem: islem, 
        makinaNo: seciliMakina.no, // Makine NumarasÄ±
        makinaAd: seciliMakina.ad, // Makine Ä°smi
        kullanici: localStorage.getItem('depoUser'), 
        timestamp: new Date().toLocaleString('tr-TR') 
    };

    document.getElementById('loading-overlay').style.display = 'flex';
    try {
        await fetch(SCRIPT_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify(veri) 
        });
        alert("Ä°ÅŸlem BaÅŸarÄ±yla Kaydedildi!");
        location.reload();
    } catch (e) { 
        alert("BaÄŸlantÄ± HatasÄ±!"); 
        document.getElementById('loading-overlay').style.display = 'none';
    }
}


async function gecmisGoster() {
    showPage('page-history');
    document.getElementById('history-body').innerHTML = '<tr><td colspan="8" style="text-align:center;">YÃ¼kleniyor...</td></tr>';
    
    try {
        const res = await fetch(GECMIS_URL);
        const text = await res.text();
        const wb = XLSX.read(text, {type:'string'});
        const sheetName = wb.SheetNames[0]; 
        
        // Verileri dizi olarak al (BaÅŸlÄ±k satÄ±rÄ±nÄ± atla ve ters Ã§evir)
        rawHistory = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {header: 1}).slice(1).reverse();
        
        // Excel Tarih SayÄ±sÄ±nÄ± (Serial Number) Normal Tarihe Ã‡eviren Fonksiyon
        const excelDateToJS = (serial) => {
            if(!serial || isNaN(serial)) return serial; // EÄŸer sayÄ± deÄŸilse olduÄŸu gibi bÄ±rak
            let date = new Date(Math.round((serial - 25569) * 86400 * 1000));
            return date.toLocaleString('tr-TR');
        };

        document.getElementById('history-body').innerHTML = rawHistory.slice(0, 50).map(row => {
            // Tarih genellikle en sonda (7. veya 8. sÃ¼tun) olur, kontrol ederek Ã§eviriyoruz
            let hamTarih = row[7] || row[6] || '-';
            let temizTarih = (typeof hamTarih === 'number') ? excelDateToJS(hamTarih) : hamTarih;

            return `
                <tr>
                    <td>${temizTarih}</td> <td>${row[6] || row[5] || '-'}</td>
                    <td>${row[3] || '-'}</td>
                    <td>${row[0] || '-'}</td>
                    <td style="font-size:9px;">${row[1] ? row[1].substring(0,20) : '-'}</td>
                    <td>${row[2] || '-'}</td>
                    <td>${row[4] || '-'}</td>
                    <td>${row[5] || '-'}</td>
                    <td>${row[8] || '-'}</td>
                </tr>
            `;
        }).join('');
    } catch (e) {
        document.getElementById('history-body').innerHTML = '<tr><td colspan="8" style="text-align:center; color:red;">Veri Ã§ekilemedi!</td></tr>';
    }
}
    function showPage(pId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        document.getElementById(pId).classList.add('active-page');
        document.getElementById('main-top-bar').style.display = (pId === 'page-login') ? 'none' : 'flex';
        document.getElementById('btn-back').style.display = (pId === 'page-search' || pId === 'page-login') ? 'none' : 'block';
    }

    function goBack() { showPage('page-search'); }
    function closeModal() { document.getElementById('custom-modal').style.display = 'none'; }
    function toggleImage() { const p = document.getElementById('detail-image-panel'); p.style.display = p.style.display === "none" ? "block" : "none"; }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
    function toggleMenu(e) { e.stopPropagation(); const d = document.getElementById('dropdown'); d.style.display = d.style.display === 'block' ? 'none' : 'block'; }
    function closeMenuOutside() { document.getElementById('dropdown').style.display = 'none'; }
    function guvenliCikis() { localStorage.removeItem('depoUser'); location.reload(); }

    window.onload = async () => {
        urunler = JSON.parse(localStorage.getItem('valeo_cache_urun') || '[]');
        kullanicilar = JSON.parse(localStorage.getItem('valeo_cache_user') || '[]');
        makineler = JSON.parse(localStorage.getItem('valeo_cache_makina') || '[]');
        if (localStorage.getItem('depoUser')) showPage('page-search');
        if(navigator.onLine) {
            try {
                const parse = async (u) => XLSX.utils.sheet_to_json(XLSX.read(await (await fetch(u)).text(), {type:'string'}).Sheets.Sheet1);
                [kullanicilar, urunler, makineler] = await Promise.all([parse(USER_URL), parse(URUN_URL), parse(MAKINA_URL)]);
                localStorage.setItem('valeo_cache_user', JSON.stringify(kullanicilar));
                localStorage.setItem('valeo_cache_urun', JSON.stringify(urunler));
                localStorage.setItem('valeo_cache_makina', JSON.stringify(makineler));
            } catch (e) {}
        }
        document.getElementById('loading-overlay').style.display = 'none';
    };
</script>
</body>
</html>
