<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valeo Bakƒ±m Portalƒ± - V2 PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --valeo-green: #99cc00; 
            --valeo-blue: #0091ff; 
            --valeo-dark: #1a1a1b; 
            --bg-gray: #f8f9fa; 
            --card-bg: #ffffff; 
            --text-main: #2d3436; 
            --text-sub: #636e72; 
            --danger: #ff4757; 
            --warning: #f1c40f;
            --shadow: 0 10px 25px rgba(0,0,0,0.08); 
            --border: #edf2f7;
        }
        
        body.dark-mode { 
            --bg-gray: #121212; 
            --card-bg: #1e1e1e; 
            --text-main: #f5f6fa; 
            --text-sub: #b2bec3; 
            --valeo-dark: #000000; 
            --border: #2d3436;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-gray); color: var(--text-main); margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; transition: 0.3s; padding: 10px; box-sizing: border-box; }
        
        .container { 
            background: var(--card-bg); 
            width: 100%; 
            max-width: 500px; 
            height: 95vh; 
            border-radius: 24px; 
            box-shadow: var(--shadow); 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            position: relative; 
            border: 1px solid var(--border); 
        }

        /* √áEVRƒ∞MDI≈ûI Bƒ∞LGƒ∞ √áUBUƒûU */
        #offline-banner {
            display: none;
            background: var(--warning);
            color: #000;
            text-align: center;
            padding: 8px;
            font-size: 11px;
            font-weight: 800;
            z-index: 100;
        }

        .top-bar { background: var(--valeo-dark); color: white; padding: 18px; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        
        .connection-status { display: flex; align-items: center; gap: 8px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot-online { background: var(--valeo-green); box-shadow: 0 0 5px var(--valeo-green); }
        .dot-offline { background: var(--danger); box-shadow: 0 0 5px var(--danger); }
        .q-count { background: var(--danger); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; display: none; }

        .content { padding: 20px; overflow-y: auto; flex-grow: 1; }
        
        /* O √áOK SEVDƒ∞ƒûƒ∞N GENƒ∞≈û ARAMA √áUBUƒûU */
        .search-container { position: relative; margin-bottom: 20px; }
        .search-container input { 
            width: 100%; padding: 20px 20px 20px 55px; border-radius: 18px; 
            border: 2px solid var(--border); background: var(--card-bg); 
            color: var(--text-main); font-size: 16px; font-weight: 600;
            box-sizing: border-box; transition: 0.3s;
        }
        .search-container input:focus { border-color: var(--valeo-green); outline: none; box-shadow: 0 0 15px rgba(153, 204, 0, 0.1); }
        .search-icon { position: absolute; left: 20px; top: 22px; font-size: 20px; opacity: 0.5; }

        .product-card { 
            background: var(--card-bg); border: 1px solid var(--border); 
            margin-bottom: 12px; padding: 18px; border-radius: 20px; 
            border-left: 6px solid var(--valeo-green); cursor: pointer; transition: 0.2s; 
        }
        .product-card:active { transform: scale(0.97); }

        button { background: var(--valeo-green); color: white; border: none; padding: 18px; border-radius: 15px; font-weight: 800; cursor: pointer; width: 100%; transition: 0.2s; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        #loading { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:1000; justify-content:center; align-items:center; flex-direction:column; }
        
        .page { display: none; height: 100%; flex-direction: column; animation: fadeIn 0.3s; }
        .active-page { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div id="offline-banner">‚ö†Ô∏è ƒ∞NTERNET YOK - ƒ∞≈ûLEMLER SIRAYA ALINIYOR</div>

    <div id="loading">
        <div style="border:4px solid #f3f3f3; border-top:4px solid var(--valeo-green); border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite;"></div>
        <p style="font-weight:800; margin-top:10px;">L√úTFEN BEKLEYƒ∞N...</p>
    </div>

    <div id="main-nav" class="top-bar" style="display:none;">
        <div style="display:flex; align-items:center; gap:12px;">
            <div id="back-btn" onclick="goBack()" style="display:none; cursor:pointer; font-size:20px;">‚¨ÖÔ∏è</div>
            <div>
                <div style="font-size:11px; font-weight:800; letter-spacing:1px;">VALEO PORTAL</div>
                <div class="connection-status">
                    <div id="status-dot" class="dot dot-online"></div>
                    <span id="status-text" style="font-size:9px;">Online</span>
                    <span id="q-badge" class="q-count">0</span>
                </div>
            </div>
        </div>
        <div onclick="toggleMenu()" style="cursor:pointer; font-size:20px;">‚ò∞</div>
    </div>

    <div id="page-login" class="page active-page">
        <div class="content" style="display:flex; flex-direction:column; justify-content:center; text-align:center;">
            <h1 style="color:var(--valeo-green); font-size:45px; margin:0; font-weight:800;">Valeo</h1>
            <p style="letter-spacing:3px; font-size:10px; opacity:0.6; margin-bottom:40px;">BAKIM DEPO Sƒ∞STEMƒ∞</p>
            <input type="text" id="user-in" placeholder="Kullanƒ±cƒ± Adƒ±" style="width:100%; padding:15px; border-radius:12px; border:2px solid var(--border); margin-bottom:10px;">
            <input type="password" id="pass-in" placeholder="≈ûifre" style="width:100%; padding:15px; border-radius:12px; border:2px solid var(--border); margin-bottom:20px;">
            <button onclick="login()">Sƒ∞STEME Gƒ∞Rƒ∞≈û</button>
        </div>
    </div>

    <div id="page-search" class="page">
        <div class="content">
            <h3 style="font-weight:800; margin-top:0;">Stok Arama</h3>
            <div class="search-container">
                <span class="search-icon">üîç</span>
                <input type="text" id="main-search" placeholder="SAP veya Malzeme adƒ± yazƒ±n..." oninput="search()">
            </div>
            <div id="search-results"></div>
        </div>
    </div>

    <div id="page-action" class="page">
        <div class="content">
            <h2 id="item-name" style="margin:0;"></h2>
            <div id="item-sap" style="color:var(--valeo-blue); font-weight:800; font-size:18px; margin:10px 0 20px 0;"></div>
            
            <div style="background:var(--bg-gray); padding:15px; border-radius:15px; margin-bottom:20px;">
                <label style="font-size:11px; font-weight:800; color:var(--text-sub);">MAKƒ∞NE SE√áƒ∞Mƒ∞</label>
                <input type="text" id="m-search" placeholder="Makine Ara..." oninput="searchM()" style="width:100%; padding:12px; border-radius:10px; border:1px solid var(--border); margin-top:5px;">
                <div id="m-results" style="max-height:120px; overflow-y:auto; margin-top:5px;"></div>
                <div id="m-sel" style="display:none; margin-top:10px; background:var(--valeo-blue); color:white; padding:12px; border-radius:12px; font-weight:800; font-size:14px;"></div>
            </div>

            <div style="display:flex; align-items:center; justify-content:center; gap:25px; margin-bottom:30px;">
                <button onclick="qty(-1)" style="width:65px; background:var(--valeo-dark); font-size:24px;">-</button>
                <span id="qty-txt" style="font-size:32px; font-weight:800;">1</span>
                <button onclick="qty(1)" style="width:65px; background:var(--valeo-dark); font-size:24px;">+</button>
            </div>

            <div style="display:flex; gap:12px;">
                <button onclick="save('STOKTAN D√ú≈û√úM')" style="background:var(--danger); flex:1; height:70px;">üìâ D√ú≈û√úM</button>
                <button onclick="save('Sƒ∞PARƒ∞≈û TALEBƒ∞')" style="background:var(--valeo-dark); flex:1; height:70px;">üõí TALEP</button>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxGCCJo34saMWKeLiFKUaWZzZh3k4sIoAiRYZ_oV7rNPWtf60UaXJUKWIn0g27RRMsIRg/exec';
    const URL_P = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBzW/pub?gid=1489941403&single=true&output=csv';
    const URL_M = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBzW/pub?gid=1658888580&single=true&output=csv';
    const URL_U = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTXdjBr4A8_FYBOe7FyxChJthgtaV1S57HxARC8MBsuxdGHywNAv7fLpxZrmK3yheolwBk26U-PSBzW/pub?gid=1584268931&single=true&output=csv';

    let DB_P = [], DB_M = [], DB_U = [], SEL_P = null, SEL_M = null, CUR_QTY = 1;
    let isSyncing = false;

    // OFFLINE Sƒ∞STEMƒ∞
    function getQ() { return JSON.parse(localStorage.getItem('v_q') || '[]'); }
    function setQ(q) { 
        localStorage.setItem('v_q', JSON.stringify(q));
        document.getElementById('q-badge').innerText = q.length;
        document.getElementById('q-badge').style.display = q.length > 0 ? 'inline-block' : 'none';
    }

    window.addEventListener('online', updateConn);
    window.addEventListener('offline', updateConn);

    function updateConn() {
        const on = navigator.onLine;
        document.getElementById('status-dot').className = on ? 'dot dot-online' : 'dot dot-offline';
        document.getElementById('status-text').innerText = on ? '√áevrimi√ßi' : '√áevrimdƒ±≈üƒ±';
        document.getElementById('offline-banner').style.display = on ? 'none' : 'block';
        if(on) sync();
    }

    async function sync() {
        if(isSyncing || !navigator.onLine) return;
        let q = getQ(); if(q.length === 0) return;
        isSyncing = true;
        while(q.length > 0) {
            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(q[0]) });
                q.shift(); setQ(q);
            } catch(e) { break; }
        }
        isSyncing = false;
    }

    // UYGULAMA
    function login() {
        const u = document.getElementById('user-in').value.trim().toLowerCase();
        const p = document.getElementById('pass-in').value.trim();
        const ok = DB_U.find(x => x[0]?.toString().toLowerCase() === u && x[1]?.toString() === p);
        if(ok) { localStorage.setItem('depoUser', u); showPage('page-search'); } else alert("Hatalƒ± Giri≈ü!");
    }

    function search() {
        const v = document.getElementById('main-search').value.toLowerCase();
        const res = document.getElementById('search-results');
        if(!v) { res.innerHTML = ""; return; }
        const f = DB_P.filter(x => x[0].toString().includes(v) || x[1].toLowerCase().includes(v));
        res.innerHTML = f.slice(0,20).map(x => `
            <div class="product-card" onclick="openItem('${x[0]}')">
                <div style="font-size:11px; color:var(--valeo-blue); font-weight:800;">SAP: ${x[0]}</div>
                <div style="font-weight:700; margin:5px 0; font-size:15px;">${x[1]}</div>
                <div style="font-size:12px; opacity:0.7;">üìç ${x[2]} | üì¶ Stok: ${x[3]}</div>
            </div>
        `).join('');
    }

    function openItem(sap) {
        SEL_P = DB_P.find(x => x[0].toString() === sap);
        document.getElementById('item-name').innerText = SEL_P[1];
        document.getElementById('item-sap').innerText = "SAP: " + SEL_P[0];
        SEL_M = null; CUR_QTY = 1; updateQty();
        document.getElementById('m-sel').style.display = "none";
        showPage('page-action');
    }

    function searchM() {
        const v = document.getElementById('m-search').value.toLowerCase();
        const res = document.getElementById('m-results');
        if(!v) { res.innerHTML = ""; return; }
        const f = DB_M.filter(x => x[0].toLowerCase().includes(v) || x[1].toLowerCase().includes(v));
        res.innerHTML = f.slice(0,5).map(x => `
            <div onclick="selM('${x[0]}','${x[1]}')" style="padding:12px; border-bottom:1px solid #eee; cursor:pointer; font-size:13px;">
                <b>${x[0]}</b> - ${x[1]}
            </div>
        `).join('');
    }

    function selM(id, ad) {
        SEL_M = {id, ad};
        const b = document.getElementById('m-sel');
        b.innerText = "SE√áƒ∞LDƒ∞: " + id; b.style.display = "block";
        document.getElementById('m-results').innerHTML = "";
        document.getElementById('m-search').value = "";
    }

    function qty(v) { CUR_QTY += v; if(CUR_QTY < 1) CUR_QTY = 1; updateQty(); }
    function updateQty() { document.getElementById('qty-txt').innerText = CUR_QTY; }

    async function save(type) {
        if(!SEL_M) { alert("L√ºtfen makine se√ßin!"); return; }
        const d = { sap: SEL_P[0], ad: SEL_P[1], adet: CUR_QTY, islem: type, makina: SEL_M.id, kullanici: localStorage.getItem('depoUser'), tarih: new Date().toLocaleString() };
        
        if(!navigator.onLine) {
            let q = getQ(); q.push(d); setQ(q);
            alert("ƒ∞nternet yok, i≈ülem kuyruƒüa alƒ±ndƒ±!");
            showPage('page-search'); return;
        }

        document.getElementById('loading').style.display = "flex";
        try {
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(d) });
            alert("Ba≈üarƒ±lƒ±!");
            showPage('page-search');
        } catch(e) {
            let q = getQ(); q.push(d); setQ(q);
            alert("Kuyruƒüa eklendi.");
        } finally { document.getElementById('loading').style.display = "none"; }
    }

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active-page'));
        document.getElementById(id).classList.add('active-page');
        document.getElementById('main-nav').style.display = id === 'page-login' ? 'none' : 'flex';
        document.getElementById('back-btn').style.display = id === 'page-search' ? 'none' : 'block';
    }

    function goBack() { showPage('page-search'); }
    function toggleMenu() { alert("V2 PRO - Ayarlar"); }

    window.onload = async () => {
        DB_P = JSON.parse(localStorage.getItem('c_p') || '[]');
        DB_M = JSON.parse(localStorage.getItem('c_m') || '[]');
        DB_U = JSON.parse(localStorage.getItem('c_u') || '[]');
        setQ(getQ()); updateConn();
        if(localStorage.getItem('depoUser')) showPage('page-search');

        if(navigator.onLine) {
            try {
                const [p, m, u] = await Promise.all([ fetch(URL_P).then(r=>r.text()), fetch(URL_M).then(r=>r.text()), fetch(URL_U).then(r=>r.text()) ]);
                const parse = (c) => XLSX.utils.sheet_to_json(XLSX.read(c,{type:'string'}).Sheets.Sheet1,{header:1}).slice(1);
                DB_P = parse(p); DB_M = parse(m); DB_U = parse(u);
                localStorage.setItem('c_p', JSON.stringify(DB_P));
                localStorage.setItem('c_m', JSON.stringify(DB_M));
                localStorage.setItem('c_u', JSON.stringify(DB_U));
            } catch(e) {}
        }
    }
</script>
<style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
</body>
</html>
