<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gelişmiş Depo Takip Sistemi</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Orijinal CSS yapını koruyup yeni modalleri ekledim */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; cursor: pointer; }
        tr:hover { background-color: #f1f1f1; }
        
        /* Yeni Modal Tasarımları */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 12px; position: relative; }
        .detay-baslik { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
        
        /* İstediğin Buton Sıralaması */
        .btn-gorsel { width: 100%; background: #34495e; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 15px; }
        .gorsel-alan { width: 100%; height: 150px; background: #eee; display: none; margin-bottom: 15px; border: 1px dashed #999; text-align: center; line-height: 150px; }
        .btn-urun-sec { width: 100%; background: #27ae60; color: white; padding: 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1.1em; }
        
        .islem-butonlari { display: flex; gap: 10px; margin-top: 20px; }
        .btn-stok { background: #e67e22; color: white; flex: 1; padding: 15px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-siparis { background: #f1c40f; color: black; flex: 1; padding: 15px; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h2>Malzeme Arama Paneli</h2>
    <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Malzeme adı veya SAP kodu ile arayın...">
    <div id="tableContainer">
        <p>Lütfen Excel dosyasını yükleyin...</p>
    </div>
</div>

<div id="modalDetay" class="modal">
    <div class="modal-content">
        <button class="btn-gorsel" onclick="toggleGorsel()">GÖRSELE BAK / GİZLE</button>
        <div id="gorselAlan" class="gorsel-alan">MALZEME GÖRSELİ</div>
        
        <div id="malzemeBilgiAlan">
            </div>
        
        <button class="btn-urun-sec" onclick="openMakineModal()">BU ÜRÜNÜ SEÇ</button>
        <button onclick="closeModal('modalDetay')" style="margin-top:10px; background:none; border:none; color:red; cursor:pointer; width:100%;">İptal</button>
    </div>
</div>

<div id="modalMakine" class="modal">
    <div class="modal-content">
        <div class="detay-baslik">İşlem Bilgileri</div>
        
        <label>Makine Numarası Ara (Sayfa 4):</label>
        <input type="text" id="makineSearch" list="makineListesi" placeholder="Makine No Seçin...">
        <datalist id="makineListesi"></datalist>
        
        <label>Adet:</label>
        <input type="number" id="adetInput" placeholder="Adet giriniz..." min="1">
        
        <div class="islem-butonlari">
            <button class="btn-stok" onclick="finalOnay('STOKTAN DÜŞÜM')">STOKTAN DÜŞÜM</button>
            <button class="btn-siparis" onclick="finalOnay('SİPARİŞ TALEBİ')">SİPARİŞ TALEBİ</button>
        </div>
    </div>
</div>

<script>
    let fullData = []; // Sayfa 1
    let makineData = []; // Sayfa 4
    let selectedItem = null;

    // DOSYA OKUMA (Mevcut mantığınla entegre)
    window.onload = function() {
        // Burada senin orijinal dosya okuma fonksiyonun çalışacak
        // Örnek olarak Sayfa 1 ve Sayfa 4'ü belleğe alıyoruz
    };

    function renderTable(data) {
        let html = '<table><tr><th>SAP KODU</th><th>MALZEME ADI</th><th>ADRES</th><th>STOK</th></tr>';
        data.forEach((item, index) => {
            html += `<tr onclick="openDetayModal(${index})">
                <td>${item.SAP_KODU || ''}</td>
                <td>${item.MALZEME_ADI || ''}</td>
                <td>${item.ADRES || ''}</td>
                <td>${item.ADET || 0}</td>
            </tr>`;
        });
        html += '</table>';
        document.getElementById('tableContainer').innerHTML = html;
        fullData = data;
    }

    function openDetayModal(index) {
        selectedItem = fullData[index];
        const alan = document.getElementById('malzemeBilgiAlan');
        alan.innerHTML = `
            <div class="detay-baslik">${selectedItem.MALZEME_ADI}</div>
            <p><b>SAP Kodu:</b> ${selectedItem.SAP_KODU}</p>
            <p><b>Raf Adresi:</b> ${selectedItem.ADRES}</p>
            <p><b>Mevcut Stok:</b> ${selectedItem.ADET}</p>
        `;
        document.getElementById('modalDetay').style.display = 'block';
    }

    function toggleGorsel() {
        const alan = document.getElementById('gorselAlan');
        alan.style.display = (alan.style.display === 'none') ? 'block' : 'none';
    }

    function openMakineModal() {
        document.getElementById('modalDetay').style.display = 'none';
        document.getElementById('modalMakine').style.display = 'block';
        
        // Sayfa 4'ten makine listesini datalist'e doldur
        const list = document.getElementById('makineListesi');
        list.innerHTML = "";
        // Excel'den gelen makineData burada dönecek
        makineData.forEach(m => {
            let opt = document.createElement('option');
            opt.value = m.MAKINE_NO || m["Makina Numarası"];
            list.appendChild(opt);
        });
    }

    function finalOnay(islemTipi) {
        const makine = document.getElementById('makineSearch').value;
        const adet = document.getElementById('adetInput').value;

        if(!makine || !adet || adet <= 0) {
            alert("EKSİK BİLGİ: Lütfen Makine ve geçerli bir Adet giriniz.");
            return;
        }

        const onay = confirm(`
            İŞLEM ONAYI
            Malzeme: ${selectedItem.MALZEME_ADI}
            Adet: ${adet}
            Makine: ${makine}
            İşlem: ${islemTipi}
            
            Onaylıyor musunuz?
        `);

        if(onay) {
            saveToSayfa3(selectedItem, makine, adet, islemTipi);
        }
    }

    function saveToSayfa3(item, makine, adet, islem) {
        // Mevcut Excel yazma fonksiyonunu buraya bağla
        console.log("Sayfa 3 Kaydı:", {item, makine, adet, islem});
        alert("İşlem başarıyla kaydedildi!");
        location.reload();
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    // Filtreleme fonksiyonunu buraya ekle (Orijinal kodundaki gibi)
    function filterTable() {
        let input = document.getElementById("searchInput").value.toUpperCase();
        let filtered = fullData.filter(x => 
            (x.MALZEME_ADI && x.MALZEME_ADI.toString().toUpperCase().includes(input)) ||
            (x.SAP_KODU && x.SAP_KODU.toString().toUpperCase().includes(input))
        );
        renderTable(filtered);
    }
</script>

</body>
</html>
